<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tickets - Portail Client TDE Group</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../src/style.css" />
    <link rel="stylesheet" href="./styles/client-theme.css" />

    <style>
        :root {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --secondary: #2563eb;
            --warning: #d97706;
            --danger: #be123c;
            --ink: #0f172a;
            --muted: #64748b;
            --surface: #f1f5f9;
            --soft: #e2e8f0;
            --card: #ffffff;
            --shadow-sm: 0 10px 22px rgba(15, 23, 42, 0.08);
            --shadow-md: 0 20px 34px rgba(15, 23, 42, 0.14);
            --radius-lg: 18px;
            --radius-md: 12px;
            --transition: all 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.client-portal {
            background:
                radial-gradient(circle at 8% 10%, rgba(13, 148, 136, 0.09), transparent 36%),
                radial-gradient(circle at 92% 14%, rgba(37, 99, 235, 0.08), transparent 38%),
                var(--surface);
        }

        .tickets-layout {
            min-height: 100vh;
            display: flex;
        }

        .tickets-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .tickets-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--soft);
            padding: 18px 20px;
        }

        .header-grid {
            width: min(1220px, 100%);
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            margin: 0;
            font-family: 'Sora', sans-serif;
            color: var(--ink);
            font-size: clamp(1.35rem, 2.2vw, 2rem);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title h1 .material-icons {
            color: var(--primary);
            font-size: 1.9rem;
        }

        .header-title p {
            margin: 6px 0 0;
            color: var(--muted);
            font-size: 0.92rem;
        }

        .ticket-badge {
            border: 1px solid rgba(13, 148, 136, 0.24);
            border-radius: 999px;
            background: rgba(13, 148, 136, 0.08);
            color: var(--primary-dark);
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .tickets-wrap {
            width: min(1220px, 100%);
            margin: 0 auto;
            padding: 20px;
        }

        .bonus-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 14px;
            margin-bottom: 14px;
        }

        .bonus-card {
            background: #fff;
            border: 1px solid var(--soft);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 16px;
        }

        .bonus-title {
            margin: 0 0 10px;
            font-family: 'Sora', sans-serif;
            color: var(--ink);
            font-size: 0.98rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bonus-title .material-icons {
            font-size: 20px;
            color: var(--primary);
        }

        .project-name {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--ink);
        }

        .project-meta {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .meta-pill {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            border: 1px solid var(--soft);
            border-radius: 999px;
            background: #f8fafc;
            color: var(--ink);
            font-size: 0.8rem;
            font-weight: 700;
            padding: 6px 10px;
        }

        .meta-pill .material-icons {
            font-size: 14px;
            color: var(--primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-box {
            border: 1px solid var(--soft);
            border-radius: var(--radius-md);
            padding: 10px;
            background: linear-gradient(135deg, rgba(13, 148, 136, 0.08), #ffffff 80%);
        }

        .stat-label {
            margin: 0 0 2px;
            color: var(--muted);
            font-size: 0.72rem;
        }

        .stat-value {
            margin: 0;
            font-family: 'Sora', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            color: var(--ink);
        }

        .actions-bar,
        .tools-bar {
            background: #fff;
            border: 1px solid var(--soft);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 12px;
            margin-bottom: 12px;
        }

        .actions-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.82rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .quick-btn .material-icons { font-size: 18px; }

        .quick-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; }
        .quick-btn.secondary { background: linear-gradient(135deg, var(--secondary), #1d4ed8); color: #fff; }
        .quick-btn.warning { background: linear-gradient(135deg, #f59e0b, var(--warning)); color: #fff; }
        .quick-btn.ghost { background: #f8fafc; border: 1px solid var(--soft); color: var(--ink); }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.16);
        }

        .tools-bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .search-wrap {
            position: relative;
        }

        .search-wrap .material-icons {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 18px;
        }

        .search-wrap input {
            width: 100%;
            border: 1px solid var(--soft);
            border-radius: 10px;
            padding: 10px 10px 10px 34px;
            font-size: 0.86rem;
            color: var(--ink);
            outline: none;
            background: #fff;
            transition: var(--transition);
        }

        .search-wrap input:focus {
            border-color: rgba(13, 148, 136, 0.5);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.14);
        }

        .tool-actions {
            display: flex;
            gap: 8px;
        }

        .tool-select {
            border: 1px solid var(--soft);
            border-radius: 10px;
            padding: 9px 10px;
            font-size: 0.84rem;
            color: var(--ink);
            background: #fff;
        }

        .tickets-list {
            display: grid;
            gap: 10px;
        }

        .ticket-card {
            background: #fff;
            border: 1px solid var(--soft);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            padding: 14px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(12px);
            animation: riseIn 0.4s ease forwards;
        }

        .ticket-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: rgba(13, 148, 136, 0.26);
        }

        .ticket-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .ticket-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .ticket-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 800;
            color: var(--ink);
        }

        .ticket-id {
            margin: 4px 0 0;
            font-size: 0.76rem;
            color: var(--muted);
        }

        .ticket-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .tag {
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 700;
            padding: 4px 9px;
            border: 1px solid transparent;
        }

        .tag.status-open,
        .tag.status-in_progress {
            background: rgba(37, 99, 235, 0.13);
            color: #1d4ed8;
            border-color: rgba(37, 99, 235, 0.32);
        }

        .tag.status-resolved,
        .tag.status-completed,
        .tag.status-closed {
            background: rgba(13, 148, 136, 0.14);
            color: #0f766e;
            border-color: rgba(13, 148, 136, 0.34);
        }

        .tag.priority-high {
            background: rgba(190, 18, 60, 0.12);
            color: #be123c;
            border-color: rgba(190, 18, 60, 0.32);
        }

        .tag.priority-medium {
            background: rgba(245, 158, 11, 0.15);
            color: #b45309;
            border-color: rgba(245, 158, 11, 0.35);
        }

        .tag.priority-low {
            background: rgba(13, 148, 136, 0.14);
            color: #0f766e;
            border-color: rgba(13, 148, 136, 0.34);
        }

        .tag.sla-soon {
            background: rgba(245, 158, 11, 0.14);
            color: #b45309;
            border-color: rgba(245, 158, 11, 0.34);
        }

        .tag.sla-late {
            background: rgba(220, 38, 38, 0.14);
            color: #b91c1c;
            border-color: rgba(220, 38, 38, 0.32);
        }

        .tag.sla-met {
            background: rgba(16, 185, 129, 0.14);
            color: #047857;
            border-color: rgba(16, 185, 129, 0.32);
        }

        .tag.sla-waiting {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
            border-color: rgba(59, 130, 246, 0.32);
        }

        .sla-alert {
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid #fecaca;
            background: #fee2e2;
            color: #991b1b;
            padding: 11px 12px;
            font-size: 0.84rem;
            font-weight: 700;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .sla-alert.show {
            display: flex;
        }

        .sla-alert .material-icons {
            font-size: 18px;
        }

        .ticket-desc {
            margin: 10px 0;
            color: #334155;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ticket-response {
            background: rgba(13, 148, 136, 0.08);
            border: 1px solid rgba(13, 148, 136, 0.22);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .ticket-response p {
            margin: 0;
            color: #0f766e;
            font-size: 0.84rem;
            line-height: 1.45;
        }

        .ticket-foot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            font-size: 0.76rem;
            color: var(--muted);
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
        }

        .ticket-foot-left {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .ticket-foot-left .material-icons {
            font-size: 14px;
            color: var(--primary);
        }

        .mini-btn {
            border: 1px solid var(--soft);
            border-radius: 9px;
            background: #fff;
            color: var(--muted);
            padding: 6px 9px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .mini-btn .material-icons { font-size: 15px; }

        .mini-btn:hover {
            background: rgba(13, 148, 136, 0.08);
            border-color: rgba(13, 148, 136, 0.36);
            color: var(--primary-dark);
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            background: #fff;
            padding: 24px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.56);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 120;
            padding: 14px;
        }

        .modal.open {
            display: flex;
        }

        .modal-card {
            width: min(760px, 100%);
            max-height: 92vh;
            overflow-y: auto;
            background: #fff;
            border-radius: 16px;
            border: 1px solid var(--soft);
            box-shadow: var(--shadow-md);
        }

        .modal-head {
            position: sticky;
            top: 0;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background: #fff;
            border-bottom: 1px solid var(--soft);
            padding: 14px;
        }

        .modal-head h2 {
            margin: 0;
            font-family: 'Sora', sans-serif;
            font-size: 1.08rem;
            color: var(--ink);
        }

        .close-btn {
            border: 1px solid var(--soft);
            border-radius: 10px;
            background: #fff;
            color: var(--muted);
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .ticket-form {
            padding: 14px;
            display: grid;
            gap: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .field label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--ink);
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            border: 1px solid var(--soft);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.86rem;
            color: var(--ink);
            outline: none;
            transition: var(--transition);
            background: #fff;
        }

        .field textarea {
            min-height: 120px;
            resize: vertical;
        }

        .field input:focus,
        .field textarea:focus,
        .field select:focus {
            border-color: rgba(13, 148, 136, 0.5);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.14);
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 4px;
        }

        .btn {
            border-radius: 10px;
            padding: 9px 12px;
            font-size: 0.84rem;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--soft);
            background: #fff;
            color: var(--muted);
        }

        .btn.primary {
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
        }

        @keyframes riseIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1080px) {
            .bonus-grid {
                grid-template-columns: 1fr;
            }

            .tools-bar {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .tickets-header {
                padding: 14px 12px;
            }

            .tickets-wrap {
                padding: 12px;
            }

            .header-grid {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="client-portal antialiased">
    <div class="tickets-layout">
        <aside class="client-sidebar hidden lg:flex w-72 flex-col sticky top-0 h-screen z-20">
            <div class="p-6 border-b border-white/10">
                <div class="sidebar-brand cursor-pointer" onclick="window.location.href='./dashboard.html'">
                    <img src="/logo.png" alt="TDE Group">
                    <div>
                        <h2 class="font-bold text-gray-900">My Project</h2>
                        <p class="text-xs text-gray-500">Client Portal</p>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav flex-1 overflow-y-auto p-4 space-y-2">
                <a href="./dashboard.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">dashboard</span>
                    <span>Tableau de bord</span>
                </a>
                <a href="./timeline.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">timeline</span>
                    <span>Timeline</span>
                </a>
                <a href="./calendar.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">calendar_month</span>
                    <span>Calendrier</span>
                </a>
                <a href="./documents.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">folder</span>
                    <span>Documents</span>
                </a>
                <a href="./chat.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">chat</span>
                    <span>Messages</span>
                    <span id="chatBadge" class="badge-count" hidden>0</span>
                </a>
                <a href="./tickets.html" class="nav-item nav-link active flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">support_agent</span>
                    <span>Tickets</span>
                    <span id="ticketBadge" class="badge-count" hidden>0</span>
                </a>
                <a href="./profile.html" class="nav-item nav-link flex items-center gap-3 px-4 py-3 rounded-lg transition-colors">
                    <span class="material-icons">person</span>
                    <span>Profil</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-200 space-y-3">
                <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors font-medium" type="button">
                    <span class="material-icons">logout</span>
                    <span>Déconnexion</span>
                </button>
            </div>
        </aside>

        <main class="tickets-main">
            <header class="tickets-header">
                <div class="header-grid">
                    <div class="header-title">
                        <h1>
                            <span class="material-icons">confirmation_number</span>
                            Tickets Support
                        </h1>
                        <p>Suivez, filtrez et créez vos demandes en quelques secondes.</p>
                    </div>
                    <div id="ticketStatusBadge" class="ticket-badge">0 ticket ouvert</div>
                </div>
            </header>

            <div class="tickets-wrap">
                <section class="bonus-grid">
                    <article class="bonus-card">
                        <h2 class="bonus-title">
                            <span class="material-icons">workspaces</span>
                            Bonus Projet
                        </h2>
                        <p id="projectName" class="project-name">Chargement...</p>
                        <div class="project-meta">
                            <span class="meta-pill"><span class="material-icons">badge</span><span id="projectId">-</span></span>
                            <span class="meta-pill"><span class="material-icons">person</span><span id="projectManager">-</span></span>
                            <span class="meta-pill"><span class="material-icons">category</span><span id="projectType">-</span></span>
                            <span class="meta-pill"><span class="material-icons">schedule</span><span id="sessionTime">-</span></span>
                        </div>
                    </article>

                    <article class="bonus-card">
                        <h2 class="bonus-title">
                            <span class="material-icons">analytics</span>
                            Bonus Tickets
                        </h2>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <p class="stat-label">Total tickets</p>
                                <p id="totalCount" class="stat-value">0</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Ouverts</p>
                                <p id="openCount" class="stat-value">0</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Résolus</p>
                                <p id="resolvedCount" class="stat-value">0</p>
                            </div>
                            <div class="stat-box">
                                <p class="stat-label">Priorité haute</p>
                                <p id="highPriorityCount" class="stat-value">0</p>
                            </div>
                        </div>
                    </article>
                </section>

                <section class="actions-bar" aria-label="Actions rapides tickets">
                    <button id="newTicketBtn" class="quick-btn primary" type="button">
                        <span class="material-icons">add_circle</span>
                        Nouveau ticket
                    </button>
                    <a href="./chat.html" class="quick-btn secondary">
                        <span class="material-icons">chat</span>
                        Écrire à l'équipe
                    </a>
                    <a href="./documents.html" class="quick-btn secondary">
                        <span class="material-icons">folder_open</span>
                        Joindre un document
                    </a>
                    <a href="./timeline.html" class="quick-btn warning">
                        <span class="material-icons">timeline</span>
                        Voir timeline
                    </a>
                    <button id="refreshBtn" class="quick-btn ghost" type="button">
                        <span class="material-icons">refresh</span>
                        Actualiser
                    </button>
                </section>

                <div id="slaSoonAlert" class="sla-alert" role="status" aria-live="polite">
                    <span class="material-icons">priority_high</span>
                    <span id="slaSoonAlertText">Certaines demandes nécessitent une action prochaine.</span>
                </div>

                <section class="tools-bar">
                    <div class="search-wrap">
                        <span class="material-icons">search</span>
                        <input id="ticketSearch" type="text" placeholder="Rechercher ticket par titre ou description...">
                    </div>
                    <div class="tool-actions">
                        <select id="statusFilter" class="tool-select">
                            <option value="all">Tous statuts</option>
                            <option value="open">Ouvert</option>
                            <option value="in_progress">En cours</option>
                            <option value="resolved">Résolu</option>
                            <option value="closed">Fermé</option>
                        </select>
                        <select id="priorityFilter" class="tool-select">
                            <option value="all">Toutes priorités</option>
                            <option value="high">Haute</option>
                            <option value="medium">Moyenne</option>
                            <option value="low">Basse</option>
                        </select>
                        <select id="slaFilter" class="tool-select">
                            <option value="all">SLA: Tous</option>
                            <option value="soon">À traiter bientôt</option>
                            <option value="late">En retard</option>
                            <option value="waiting">En attente équipe</option>
                            <option value="met">Pris en charge à temps</option>
                        </select>
                    </div>
                </section>

                <section id="ticketsList" class="tickets-list" aria-live="polite"></section>
            </div>
        </main>
    </div>

    <div id="newTicketModal" class="modal" onclick="if(event.target===this){closeTicketModal();}">
        <div class="modal-card">
            <div class="modal-head">
                <h2>Créer un ticket</h2>
                <button class="close-btn" type="button" onclick="closeTicketModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>

            <form id="newTicketForm" class="ticket-form">
                <div class="field">
                    <label for="ticketTitle">Titre du ticket</label>
                    <input id="ticketTitle" type="text" required placeholder="Décrivez brièvement votre problème">
                </div>

                <div class="field">
                    <label for="ticketDescription">Description</label>
                    <textarea id="ticketDescription" required placeholder="Fournissez les détails utiles pour l'équipe."></textarea>
                </div>

                <div class="form-grid">
                    <div class="field">
                        <label for="ticketCategory">Catégorie</label>
                        <select id="ticketCategory" required>
                            <option value="">Sélectionnez...</option>
                            <option value="problem">Problème</option>
                            <option value="question">Question</option>
                            <option value="suggestion">Suggestion</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="ticketPriority">Priorité</label>
                        <select id="ticketPriority" required>
                            <option value="low">Basse</option>
                            <option value="medium" selected>Moyenne</option>
                            <option value="high">Haute</option>
                        </select>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn" type="button" onclick="closeTicketModal()">Annuler</button>
                    <button class="btn primary" type="submit">Créer ticket</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../src/client-auth-service.js"></script>
    <script src="../src/client-data-service.js"></script>
    <script src="../src/client-profile-shortcut.js"></script>
    <script src="../src/client-ui-helpers.js"></script>
    <script>
        if (!clientAuthService.isAuthenticated()) {
            window.location.href = './login.html';
        }

        const ticketState = {
            all: [],
            visible: [],
            project: null,
            query: '',
            status: 'all',
            priority: 'all',
            sla: 'all'
        };
        const SLA_HOURS = { high: 2, medium: 8, low: 24 };

        document.addEventListener('DOMContentLoaded', async () => {
            setupListeners();
            await loadPageData();
            startSessionTicker();
            applyPrefillFromSession();
        });

        function setupListeners() {
            document.getElementById('newTicketBtn').addEventListener('click', openTicketModal);
            document.getElementById('refreshBtn').addEventListener('click', async () => {
                await loadPageData(true);
                ClientUIHelpers.showNotification('Tickets actualisés', 'success');
            });

            document.getElementById('ticketSearch').addEventListener('input', (event) => {
                ticketState.query = event.target.value.trim().toLowerCase();
                renderTickets();
            });

            document.getElementById('statusFilter').addEventListener('change', (event) => {
                ticketState.status = event.target.value;
                renderTickets();
            });

            document.getElementById('priorityFilter').addEventListener('change', (event) => {
                ticketState.priority = event.target.value;
                renderTickets();
            });

            document.getElementById('slaFilter').addEventListener('change', (event) => {
                ticketState.sla = event.target.value;
                renderTickets();
            });

            document.getElementById('newTicketForm').addEventListener('submit', handleCreateTicket);

            document.getElementById('logoutBtn').addEventListener('click', () => {
                ClientUIHelpers.showConfirmDialog(
                    'Confirmer la déconnexion',
                    'Souhaitez-vous vraiment vous déconnecter ?',
                    () => {
                        clientAuthService.logout();
                        window.location.href = './login.html';
                    }
                );
            });

            applyUrlFilters();
        }

        function applyUrlFilters() {
            const params = new URLSearchParams(window.location.search);
            const status = (params.get('status') || '').trim().toLowerCase();
            const priority = (params.get('priority') || '').trim().toLowerCase();
            const sla = (params.get('sla') || '').trim().toLowerCase();
            const query = (params.get('q') || '').trim();

            const statusSelect = document.getElementById('statusFilter');
            const prioritySelect = document.getElementById('priorityFilter');
            const slaSelect = document.getElementById('slaFilter');
            const searchInput = document.getElementById('ticketSearch');

            if (status && Array.from(statusSelect.options).some((o) => o.value === status)) {
                statusSelect.value = status;
                ticketState.status = status;
            }
            if (priority && Array.from(prioritySelect.options).some((o) => o.value === priority)) {
                prioritySelect.value = priority;
                ticketState.priority = priority;
            }
            if (sla && Array.from(slaSelect.options).some((o) => o.value === sla)) {
                slaSelect.value = sla;
                ticketState.sla = sla;
            }
            if (query) {
                searchInput.value = query;
                ticketState.query = query.toLowerCase();
            }
        }

        async function loadPageData(manual = false) {
            try {
                const [project, tickets, messages] = await Promise.all([
                    clientDataService.getProject(),
                    clientDataService.getTickets(),
                    clientDataService.getMessages()
                ]);

                ticketState.project = project || null;
                ticketState.all = Array.isArray(tickets) ? tickets : [];

                updateProjectBonus(project);
                updateBadges(messages || [], ticketState.all);
                renderTickets();
                updateSessionTime();

                if (manual) {
                    pulseCards();
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                ClientUIHelpers.showNotification('Erreur lors du chargement des tickets', 'error');
            }
        }

        function renderTickets() {
            const query = ticketState.query;
            const status = ticketState.status;
            const priority = ticketState.priority;
            const sla = ticketState.sla;

            const visible = ticketState.all.filter((ticket) => {
                const statusKey = normalizeStatus(ticket.status);
                const priorityKey = normalizePriority(ticket.priority);
                const matchesStatus = status === 'all' || statusKey === status;
                const matchesPriority = priority === 'all' || priorityKey === priority;
                const slaState = getTicketSlaState(ticket).state;
                const matchesSla = sla === 'all' || slaState === sla;
                const searchable = `${ticket.title || ''} ${ticket.description || ''}`.toLowerCase();
                const matchesQuery = !query || searchable.includes(query);
                return matchesStatus && matchesPriority && matchesSla && matchesQuery;
            });

            ticketState.visible = [...visible].sort((a, b) => getTicketSlaState(b).score - getTicketSlaState(a).score);

            const list = document.getElementById('ticketsList');
            if (!ticketState.visible.length) {
                list.innerHTML = '<div class="empty-state">Aucun ticket ne correspond aux filtres actifs.</div>';
                updateStats([]);
                updateSlaAlert([]);
                return;
            }

            list.innerHTML = ticketState.visible.map((ticket, index) => {
                const delay = Math.min(index * 40, 280);
                const statusKey = normalizeStatus(ticket.status);
                const priorityKey = normalizePriority(ticket.priority);
                const slaInfo = getTicketSlaState(ticket);
                return `
                    <article class="ticket-card" style="animation-delay:${delay}ms;">
                        <div class="ticket-head">
                            <div>
                                <h3 class="ticket-title">${escapeHtml(ticket.title || 'Ticket')}</h3>
                                <p class="ticket-id">#${escapeHtml(ticket.id || '-')}</p>
                            </div>
                            <div class="ticket-badges">
                                <span class="tag status-${statusKey}">${escapeHtml(getStatusLabel(statusKey))}</span>
                                <span class="tag priority-${priorityKey}">${escapeHtml(getPriorityLabel(priorityKey))}</span>
                                <span class="tag sla-${slaInfo.state}">${escapeHtml(slaInfo.label)}</span>
                            </div>
                        </div>

                        <p class="ticket-desc">${escapeHtml(ticket.description || '')}</p>

                        ${ticket.response ? `
                            <div class="ticket-response">
                                <p><strong>Réponse équipe:</strong> ${escapeHtml(ticket.response)}</p>
                            </div>
                        ` : ''}

                        <div class="ticket-foot">
                            <span class="ticket-foot-left">
                                <span class="material-icons">calendar_month</span>
                                Créé le ${ClientUIHelpers.formatDate(ticket.createdDate)}
                            </span>
                            <button class="mini-btn" type="button" onclick="copyTicketTitle('${escapeAttr(ticket.title || '')}')">
                                <span class="material-icons">content_copy</span>
                                Copier titre
                            </button>
                        </div>
                    </article>
                `;
            }).join('');

            updateStats(ticketState.visible);
            updateSlaAlert(ticketState.all);
        }

        async function handleCreateTicket(event) {
            event.preventDefault();

            const ticket = {
                title: document.getElementById('ticketTitle').value.trim(),
                description: document.getElementById('ticketDescription').value.trim(),
                category: document.getElementById('ticketCategory').value,
                priority: document.getElementById('ticketPriority').value
            };

            if (!ticket.title || !ticket.description || !ticket.category || !ticket.priority) {
                ClientUIHelpers.showNotification('Veuillez compléter tous les champs requis', 'warning');
                return;
            }

            ClientUIHelpers.showConfirmDialog(
                'Créer le ticket',
                'Confirmez-vous l\'envoi de ce ticket ?',
                async () => {
                    try {
                        await clientDataService.createTicket(ticket);
                        ClientUIHelpers.showNotification('Ticket créé avec succès', 'success');
                        closeTicketModal();
                        await loadPageData();
                    } catch (error) {
                        console.error('Create ticket error:', error);
                        ClientUIHelpers.showNotification(
                            `Erreur lors de la création du ticket: ${error?.message || 'inconnue'}`,
                            'error'
                        );
                    }
                }
            );
        }

        function updateProjectBonus(project) {
            const data = project || {};
            const projectId = data.id || clientAuthService.getProjectId() || '-';

            document.getElementById('projectName').textContent = data.name || 'Projet client';
            document.getElementById('projectId').textContent = projectId !== '-' ? `#${String(projectId).slice(0, 8)}` : '-';
            document.getElementById('projectManager').textContent = data.manager || data.project_manager || '-';
            document.getElementById('projectType').textContent = formatProjectType(data.project_type || data.type);
        }

        function updateStats(visibleTickets) {
            const all = ticketState.all;
            const open = all.filter((t) => ['open', 'in_progress'].includes(normalizeStatus(t.status))).length;
            const resolved = all.filter((t) => ['resolved', 'closed', 'completed'].includes(normalizeStatus(t.status))).length;
            const high = all.filter((t) => normalizePriority(t.priority) === 'high').length;
            const soon = all.filter((t) => getTicketSlaState(t).state === 'soon').length;
            const late = all.filter((t) => getTicketSlaState(t).state === 'late').length;

            document.getElementById('totalCount').textContent = String(all.length);
            document.getElementById('openCount').textContent = late > 0 ? `${open} (${late} retard)` : String(open);
            document.getElementById('resolvedCount').textContent = String(resolved);
            document.getElementById('highPriorityCount').textContent = soon > 0 ? `${high} (${soon} bientôt)` : String(high);
            document.getElementById('ticketStatusBadge').textContent = late > 0
                ? `${late} ticket(s) en retard de prise en charge`
                : `${open} ticket(s) ouvert(s)`;

            if (Array.isArray(visibleTickets) && visibleTickets.length === 0 && all.length > 0) {
                document.getElementById('ticketStatusBadge').textContent = 'Aucun résultat pour ce filtre';
            }
        }

        function updateBadges(messages, tickets) {
            const unreadMessages = (messages || []).filter((msg) => !msg.read).length;
            const openTickets = (tickets || []).filter((ticket) => ['open', 'in_progress'].includes(normalizeStatus(ticket.status))).length;

            const chatBadge = document.getElementById('chatBadge');
            if (chatBadge) {
                chatBadge.hidden = unreadMessages === 0;
                chatBadge.textContent = unreadMessages > 9 ? '9+' : String(unreadMessages);
            }

            const ticketBadge = document.getElementById('ticketBadge');
            if (ticketBadge) {
                ticketBadge.hidden = openTickets === 0;
                ticketBadge.textContent = openTickets > 9 ? '9+' : String(openTickets);
            }
        }

        function updateSessionTime() {
            const minutes = Math.max(0, Number(clientAuthService.getSessionTimeRemaining()) || 0);
            document.getElementById('sessionTime').textContent = `${minutes} min`;
        }

        function startSessionTicker() {
            setInterval(updateSessionTime, 60000);
            updateSessionTime();
        }

        function pulseCards() {
            document.querySelectorAll('.ticket-card').forEach((card, index) => {
                setTimeout(() => {
                    card.style.transform = 'translateY(-2px)';
                    setTimeout(() => {
                        card.style.transform = '';
                    }, 140);
                }, index * 25);
            });
        }

        function openTicketModal() {
            document.getElementById('newTicketModal').classList.add('open');
        }

        function closeTicketModal() {
            document.getElementById('newTicketModal').classList.remove('open');
            document.getElementById('newTicketForm').reset();
        }

        function applyPrefillFromSession() {
            const phaseName = sessionStorage.getItem('prefill_ticket_phase');
            if (!phaseName) return;

            const titleInput = document.getElementById('ticketTitle');
            const descInput = document.getElementById('ticketDescription');
            titleInput.value = `Question sur la phase: ${phaseName}`;
            descInput.value = `Bonjour, j'ai besoin d'un complément d'information concernant la phase "${phaseName}".`;
            sessionStorage.removeItem('prefill_ticket_phase');
            openTicketModal();
        }

        function copyTicketTitle(title) {
            if (!title) return;
            ClientUIHelpers.copyToClipboard(title);
        }

        function getTicketDate(ticket, ...fields) {
            for (const field of fields) {
                const value = ticket?.[field];
                if (!value) continue;
                const t = new Date(value).getTime();
                if (Number.isFinite(t)) return t;
            }
            return null;
        }

        function formatMinutes(minutesRaw) {
            const minutes = Math.max(0, Number(minutesRaw) || 0);
            if (minutes >= 60 * 24) return `${Math.round(minutes / (60 * 24))}j`;
            if (minutes >= 60) return `${Math.round(minutes / 60)}h`;
            return `${minutes}min`;
        }

        function getTicketSlaState(ticket) {
            const createdAt = getTicketDate(ticket, 'created_at', 'createdDate', 'createdAt');
            if (!createdAt) {
                return { state: 'waiting', label: 'En attente équipe', score: 10 };
            }
            const priority = normalizePriority(ticket?.priority);
            const dueAt = createdAt + ((SLA_HOURS[priority] || SLA_HOURS.medium) * 60 * 60 * 1000);
            const responseAt = getTicketDate(ticket, 'first_response_at', 'responded_at', 'response_at');
            const fallbackResponseAt = ticket?.response ? getTicketDate(ticket, 'updated_at', 'updatedDate', 'resolved_at') : null;
            const effectiveResponse = responseAt || fallbackResponseAt;

            if (effectiveResponse) {
                if (effectiveResponse <= dueAt) {
                    const delta = Math.round((effectiveResponse - createdAt) / 60000);
                    return { state: 'met', label: `Pris en charge (${formatMinutes(delta)})`, score: 20 };
                }
                const late = Math.round((effectiveResponse - dueAt) / 60000);
                return { state: 'late', label: `Retard (${formatMinutes(late)})`, score: 120 + Math.min(300, late) };
            }

            const status = normalizeStatus(ticket?.status);
            if (!['open', 'in_progress'].includes(status)) {
                return { state: 'waiting', label: 'En attente équipe', score: 10 };
            }

            const remaining = Math.round((dueAt - Date.now()) / 60000);
            if (remaining < 0) {
                return { state: 'late', label: `Retard (${formatMinutes(Math.abs(remaining))})`, score: 150 + Math.min(300, Math.abs(remaining)) };
            }
            if (remaining <= 60) {
                return { state: 'soon', label: `À traiter bientôt (${formatMinutes(remaining)})`, score: 90 + (60 - remaining) };
            }
            return { state: 'waiting', label: 'En attente équipe', score: 40 };
        }

        function updateSlaAlert(tickets) {
            const soonCount = (tickets || []).filter((t) => getTicketSlaState(t).state === 'soon').length;
            const lateCount = (tickets || []).filter((t) => getTicketSlaState(t).state === 'late').length;
            const alert = document.getElementById('slaSoonAlert');
            const text = document.getElementById('slaSoonAlertText');
            if (!alert || !text) return;

            if (lateCount > 0) {
                alert.classList.add('show');
                text.textContent = `${lateCount} ticket(s) en retard de prise en charge.`;
                return;
            }
            if (soonCount > 0) {
                alert.classList.add('show');
                text.textContent = `${soonCount} ticket(s) à traiter bientôt par l'équipe.`;
                return;
            }
            alert.classList.remove('show');
        }

        function normalizeStatus(status) {
            const value = String(status || '').toLowerCase();
            if (value === 'en_cours' || value === 'active' || value === 'in_work') return 'in_progress';
            if (value === 'in-progress') return 'in_progress';
            return value || 'open';
        }

        function normalizePriority(priority) {
            const value = String(priority || '').toLowerCase();
            if (['high', 'medium', 'low'].includes(value)) return value;
            return 'medium';
        }

        function getStatusLabel(status) {
            const map = {
                open: 'Ouvert',
                in_progress: 'En cours',
                'in-progress': 'En cours',
                resolved: 'Résolu',
                closed: 'Fermé',
                completed: 'Terminé'
            };
            return map[status] || status;
        }

        function getPriorityLabel(priority) {
            const map = {
                high: 'Haute',
                medium: 'Moyenne',
                low: 'Basse'
            };
            return map[priority] || priority;
        }

        function formatProjectType(type) {
            if (!type) return '-';
            return String(type)
                .replace(/[_-]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .replace(/\b\w/g, (char) => char.toUpperCase());
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function escapeAttr(value) {
            return escapeHtml(value).replace(/`/g, '&#96;');
        }

        window.closeTicketModal = closeTicketModal;
        window.copyTicketTitle = copyTicketTitle;
    </script>
  <script src="/js/refresh-feedback.js" defer></script>
</body>

</html>
