<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails Projet - TDE Group Admin</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="./styles/admin-layout.css">
    <style>
        .tabs { display: flex; gap: 0; border-bottom: 2px solid #e5e7eb; margin-bottom: 30px; }
        .tab { padding: 15px 25px; border: none; background: none; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab:hover { color: #1f2937; }
        .tab.active { color: #0d9488; border-bottom-color: #0d9488; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .project-header { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .project-title { font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 15px; }
        .project-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .meta-item { }
        .meta-label { font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px; }
        .meta-value { font-size: 16px; color: #1f2937; font-weight: 600; }
        .section { background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .progress-slider { width: 100%; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(76, 29, 149, 0.2); }
        .btn-secondary { background: #f3f4f6; color: #1f2937; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-danger { background: #fee2e2; color: #991b1b; }
        .btn-danger:hover { background: #fecaca; }
        .phase-item, .document-item, .note-item { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .item-content { flex: 1; }
        .item-title { font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .item-meta { font-size: 13px; color: #6b7280; }
        .item-actions { display: flex; gap: 8px; }
        .icon-btn { width: 36px; height: 36px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { background: #e5e7eb; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-planning { background: #e0e7ff; color: #3730a3; }
        .status-in-progress { background: #dbeafe; color: #1e40af; }
        .status-paused { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dcfce7; color: #166534; }
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; }
        .empty-state .material-icons { font-size: 48px; margin-bottom: 10px; display: block; color: #d1d5db; }
        .pin-box { background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px; }
        .pin-display { font-family: 'Courier New', monospace; font-size: 18px; font-weight: 700; color: #0d9488; letter-spacing: 2px; }
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type="file"] { display: none; }
        .file-upload-btn { display: flex; align-items: center; gap: 8px; }
        .images-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap: 12px; margin-top: 15px; }
        .image-card { position: relative; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; width: 270px; }
        .image-card img { width: 270px; height: 270px; object-fit: cover; display: block; cursor: pointer; }
        .image-caption { padding: 8px 10px; font-size: 12px; color: #475569; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .image-tag { font-size: 11px; color: #0f766e; background: #ccfbf1; padding: 2px 6px; border-radius: 999px; font-weight: 600; }
        .image-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 50; padding: 20px; }
        .image-modal.open { display: flex; }
        .image-modal-content { background: white; border-radius: 12px; max-width: 90vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .image-modal-content img { max-width: 90vw; max-height: 70vh; object-fit: contain; background: #0f172a; }
        .image-modal-actions { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px 14px; }
        .image-modal-actions .title { font-size: 14px; font-weight: 600; color: #0f172a; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo"><img src="../logo.png" alt="TDE Group"><div class="logo-text"><span>TDE GROUP</span><small>TOGETHER WE MAKE IT!</small></div></div>
        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item"><span class="material-icons">dashboard</span><span>Dashboard</span></a>
            <a href="create-project.html" class="sidebar-item"><span class="material-icons">add_circle</span><span>Nouveau Projet</span></a>
            <a href="clients.html" class="sidebar-item"><span class="material-icons">people</span><span>Clients</span></a>
            <a href="tickets.html" class="sidebar-item"><span class="material-icons">support_agent</span><span>Support</span></a>
            <a href="messages.html" class="sidebar-item"><span class="material-icons">mail</span><span>Messages</span></a>
            <a href="calendar.html" class="sidebar-item"><span class="material-icons">calendar_today</span><span>Calendrier</span></a>
            <a href="profile.html" class="sidebar-item"><span class="material-icons">account_circle</span><span>Profil</span></a>
            <div class="sidebar-logout">
                <button class="sidebar-item" onclick="logout()"><span class="material-icons">logout</span><span>Déconnexion</span></button>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-title"><span class="material-icons">edit</span><span>Détails Projet</span></div>
            <div class="header-right">
                <button class="btn-primary" onclick="saveProject()" style="padding: 8px 16px; gap: 6px;"><span class="material-icons" style="font-size: 18px;">save</span><span>Enregistrer</span></button>
                <div class="user-profile"><div class="user-avatar" id="userInitials">AD</div></div>
            </div>
        </div>

        <div class="content">
            <!-- Project Header -->
            <div class="project-header">
                <h1 class="project-title" id="projectTitle">Chargement...</h1>
                <div class="project-meta">
                    <div class="meta-item">
                        <div class="meta-label">Type</div>
                        <div class="meta-value" id="projectType">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Client</div>
                        <div class="meta-value" id="clientName">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Budget</div>
                        <div class="meta-value" id="projectBudget">FCFA 0</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Statut</div>
                        <div class="meta-value"><span class="status-badge status-planning" id="statusBadge">-</span></div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')"><span class="material-icons">info</span> Aperçu</button>
                <button class="tab" onclick="switchTab('phases')"><span class="material-icons">timeline</span> Phases</button>
                <button class="tab" onclick="switchTab('documents')"><span class="material-icons">description</span> Documents</button>
                <button class="tab" onclick="switchTab('notes')"><span class="material-icons">note</span> Notes</button>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div id="overview" class="tab-content active">
                <div class="section">
                    <h2 class="section-title"><span class="material-icons">info</span>Informations Générales</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project UUID</label>
                            <input type="text" id="projectUuid" readonly>
                        </div>
                        <div class="form-group">
                            <label>Nom du Projet</label>
                            <input type="text" id="name" placeholder="Nom du projet">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select id="projectTypeSelect">
                                <option value="construction">Construction</option>
                                <option value="consultancy">Consultancy</option>
                                <option value="energy">Energy</option>
                                <option value="it-services">IT Services</option>
                                <option value="supply">Supply</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Statut</label>
                            <select id="status">
                                <option value="active">Actif</option>
                                <option value="paused">En Pause</option>
                                <option value="completed">Complété</option>
                                <option value="cancelled">Annulé</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Progression (%)</label>
                            <input type="range" id="progress" min="0" max="100" class="progress-slider" oninput="updateProgress()">
                            <div id="progressValue" style="text-align: center; margin-top: 5px; color: #6b7280; font-size: 12px;">0%</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="material-icons">description</span>Détails du Projet</h2>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Description</label>
                            <textarea id="description" placeholder="Description du projet"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Date de Début</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label>Date de Fin</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="form-group">
                            <label>Budget (FCFA)</label>
                            <input type="number" id="budget" placeholder="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="material-icons">person</span>Informations Client</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nom du Client</label>
                            <input type="text" id="clientNameInput" placeholder="Nom du client">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="tel" id="clientPhone" placeholder="+33 6 00 00 00 00">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="material-icons">lock</span>Sécurité & Accès</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>PIN d'Accès Client</label>
                            <div class="pin-box">
                                <div class="pin-display" id="pinDisplay">000000</div>
                                <button class="btn btn-secondary" onclick="regeneratePin()"><span class="material-icons">refresh</span>Régénérer</button>
                                <button class="btn btn-secondary" onclick="copyPin()"><span class="material-icons">content_copy</span>Copier</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="material-icons">work</span>Responsable</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Responsable du Projet</label>
                            <input type="text" id="projectManager" placeholder="Nom du manager">
                        </div>
                        <div class="form-group">
                            <label>Email du Responsable</label>
                            <input type="email" id="managerEmail" placeholder="manager@example.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: PHASES -->
            <div id="phases" class="tab-content">
                <div class="section">
                    <h2 class="section-title"><span class="material-icons">timeline</span>Phases du Projet</h2>
                    <div id="phasesList"></div>
                    <button class="btn btn-primary" onclick="addPhaseForm()"><span class="material-icons">add</span>Ajouter une Phase</button>
                </div>

                <!-- Phase Add Form (Hidden by default) -->
                <div id="phaseFormContainer" style="display: none;">
                    <div class="section" style="background: #f9fafb; border: 2px dashed #0d9488;">
                        <h3 style="margin-top: 0;">Nouvelle Phase</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Titre</label>
                                <input type="text" id="phaseTitle" placeholder="Titre de la phase">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="phaseDescription" placeholder="Description">
                            </div>
                            <div class="form-group">
                                <label>Statut</label>
                                <select id="phaseStatus">
                                    <option value="planned">Planifiée</option>
                                    <option value="in_progress">En Cours</option>
                                    <option value="completed">Complétée</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Date de Début</label>
                                <input type="date" id="phaseStartDate">
                            </div>
                            <div class="form-group">
                                <label>Date de Fin</label>
                                <input type="date" id="phaseEndDate">
                            </div>
                            <div class="form-group">
                                <label>Progression (%)</label>
                                <input type="number" id="phaseProgress" min="0" max="100" value="0">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="savePhase()"><span class="material-icons">check</span>Enregistrer</button>
                            <button class="btn btn-secondary" onclick="cancelPhaseForm()"><span class="material-icons">close</span>Annuler</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: DOCUMENTS -->
            <div id="documents" class="tab-content">
                <div class="section">
                    <h2 class="section-title"><span class="material-icons">photo_camera</span>Photos du Chantier</h2>
                    <div class="file-input-wrapper">
                        <input type="file" id="siteImagesInput" accept="image/*" multiple>
                        <button class="btn btn-secondary file-upload-btn" onclick="document.getElementById('siteImagesInput').click()">
                            <span class="material-icons">add_a_photo</span>Ajouter des photos
                        </button>
                    </div>
                    <div class="form-group" style="max-width: 300px; margin-top: 10px;">
                        <label>Tag de phase</label>
                        <select id="phaseTagSelect">
                            <option value="">Sans phase</option>
                        </select>
                    </div>
                    <div id="imagesGrid" class="images-grid"></div>
                </div>

                <div class="section">
                    <h2 class="section-title"><span class="material-icons">description</span>Documents du Projet</h2>
                    <div id="documentsList"></div>
                    <button class="btn btn-primary" onclick="showDocumentUpload()"><span class="material-icons">upload</span>Ajouter un Document</button>
                </div>

                <!-- Document Upload Form (Hidden by default) -->
                <div id="documentFormContainer" style="display: none;">
                    <div class="section" style="background: #f9fafb; border: 2px dashed #0d9488;">
                        <h3 style="margin-top: 0;">Ajouter un Document</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Fichier</label>
                                <div class="file-input-wrapper">
                                    <input type="file" id="documentFile">
                                    <button class="btn btn-secondary file-upload-btn" onclick="document.getElementById('documentFile').click()">
                                        <span class="material-icons">upload_file</span>Choisir un fichier
                                    </button>
                                    <span id="fileName" style="margin-left: 10px; color: #6b7280;"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Nom du Document</label>
                                <input type="text" id="docName" placeholder="Nom du document">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="docType">
                                    <option value="devis">Devis</option>
                                    <option value="plans">Plans</option>
                                    <option value="contract">Contrat</option>
                                    <option value="invoice">Facture</option>
                                    <option value="report">Rapport</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Visible au Client?</label>
                                <select id="docVisibility">
                                    <option value="true">Oui</option>
                                    <option value="false">Non (Admin Only)</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="uploadDocument()"><span class="material-icons">check</span>Enregistrer</button>
                            <button class="btn btn-secondary" onclick="cancelDocumentForm()"><span class="material-icons">close</span>Annuler</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: NOTES (Admin Only) -->
            <div id="notes" class="tab-content">
                <div class="section">
                    <h2 class="section-title"><span class="material-icons">lock</span>Notes Internes (Admin Only)</h2>
                    <div style="background: #ffe0b2; border: 1px solid #ffb74d; border-radius: 6px; padding: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-start;">
                        <span class="material-icons" style="color: #f57c00; flex-shrink: 0;">info</span>
                        <p style="margin: 0; font-size: 13px; color: #e65100;">Ces notes sont visibles uniquement par les administrateurs. Les clients n'y ont pas accès.</p>
                    </div>
                    <div class="form-grid">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Notes Internes</label>
                            <textarea id="internalNotes" placeholder="Ajoutez vos notes privées ici..." style="min-height: 150px;"></textarea>
                            <small style="color: #6b7280; margin-top: 5px; display: block;">Auto-sauvegarde activée</small>
                        </div>
                    </div>
                    <div id="notesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import AuthService from '../src/auth-service.js';
        import ProjectStore from '../src/data-store.js';
        import PhaseService from '../src/phase-service.js';
        import DocumentService from '../src/document-service.js';
        import NotesService from '../src/notes-service.js';
        import { initAdminAvatar } from '../src/admin-avatar.js';

        let projectId = null;
        let currentProject = null;
        let autoSaveTimer = null;

        async function initialize() {
            try {
                await AuthService.authReady;
                if (!AuthService.isAdmin || !AuthService.isAdmin()) {
                    window.location.href = 'login.html';
                    return;
                }

                await initAdminAvatar();

                const params = new URLSearchParams(window.location.search);
                projectId = params.get('id');

                if (!projectId) {
                    alert('Project ID missing');
                    window.location.href = 'index.html';
                    return;
                }

                await loadProject();
                await loadPhases();
                await loadDocuments();
                await loadNotes();
                await loadImages();

                // Auto-save notes
                const notesInput = document.getElementById('internalNotes');
                notesInput.addEventListener('change', autoSaveNotes);
            } catch (error) {
                console.error('Error:', error);
                window.location.href = 'login.html';
            }
        }

        async function loadProject() {
            currentProject = await ProjectStore.getById(projectId);
            if (!currentProject) {
                alert('Project not found');
                window.location.href = 'index.html';
                return;
            }

            // Populate form
            document.getElementById('projectTitle').textContent = currentProject.name;
            document.getElementById('projectType').textContent = currentProject.project_type;
            document.getElementById('clientName').textContent = currentProject.client_name;
            document.getElementById('projectBudget').textContent = `FCFA ${Number(currentProject.budget || 0).toLocaleString('fr-FR')}`;
            document.getElementById('statusBadge').textContent = currentProject.status;
            document.getElementById('statusBadge').className = `status-badge status-${currentProject.status}`;
            document.getElementById('projectUuid').value = currentProject.id;

            document.getElementById('name').value = currentProject.name;
            document.getElementById('projectTypeSelect').value = currentProject.project_type;
            document.getElementById('status').value = currentProject.status;
            document.getElementById('progress').value = currentProject.progress || 0;
            document.getElementById('progressValue').textContent = `${currentProject.progress || 0}%`;
            document.getElementById('description').value = currentProject.description || '';
            document.getElementById('startDate').value = currentProject.start_date?.split('T')[0] || '';
            document.getElementById('endDate').value = currentProject.end_date?.split('T')[0] || '';
            document.getElementById('budget').value = currentProject.budget || 0;
            document.getElementById('clientNameInput').value = currentProject.client_name;
            document.getElementById('clientEmail').value = currentProject.client_email;
            document.getElementById('clientPhone').value = currentProject.client_phone || '';
            document.getElementById('projectManager').value = currentProject.project_manager || '';
            document.getElementById('managerEmail').value = currentProject.manager_email || '';
            document.getElementById('pinDisplay').textContent = currentProject.access_pin || '000000';
        }

        let phaseOptions = [];

        async function loadPhases() {
            const phases = await PhaseService.getByProjectId(projectId);
            const container = document.getElementById('phasesList');
            phaseOptions = phases || [];
            renderPhaseOptions();

            if (phases.length === 0) {
                container.innerHTML = '<div class="empty-state"><span class="material-icons">layers</span><p>Aucune phase</p></div>';
                return;
            }

            container.innerHTML = phases.map(phase => `
                <div class="phase-item">
                    <div class="item-content">
                        <div class="item-title">${phase.name || phase.title}</div>
                        <div class="item-meta">${phase.description}</div>
                        <div class="item-meta" style="margin-top: 8px;">
                            <strong>Statut:</strong> <span class="status-badge status-${phase.status}">${phase.status}</span>
                            <strong style="margin-left: 15px;">Progression:</strong> ${phase.progress || 0}%
                        </div>
                        <div class="item-meta" style="margin-top: 8px;">
                            ${phase.start_date ? new Date(phase.start_date).toLocaleDateString('fr-FR') : '-'} → 
                            ${phase.end_date ? new Date(phase.end_date).toLocaleDateString('fr-FR') : '-'}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="icon-btn" onclick="editPhase('${phase.id}')" title="Éditer"><span class="material-icons">edit</span></button>
                        <button class="icon-btn" onclick="deletePhase('${phase.id}')" title="Supprimer"><span class="material-icons">delete</span></button>
                    </div>
                </div>
            `).join('');
        }

        function renderPhaseOptions() {
            const select = document.getElementById('phaseTagSelect');
            if (!select) return;
            select.innerHTML = `<option value="">Sans phase</option>` + phaseOptions.map(p => `
                <option value="${p.id}">${p.name || p.title}</option>
            `).join('');
        }

        async function loadDocuments() {
            const docs = await DocumentService.getByProjectId(projectId);
            const container = document.getElementById('documentsList');

            if (docs.length === 0) {
                container.innerHTML = '<div class="empty-state"><span class="material-icons">folder_open</span><p>Aucun document</p></div>';
                return;
            }

            container.innerHTML = docs.map(doc => `
                <div class="document-item">
                    <div class="item-content">
                        <div class="item-title">${doc.name || doc.title || doc.filename}</div>
                        <div class="item-meta">
                            <strong>Type:</strong> ${doc.file_type || doc.document_type} | 
                            <strong>Taille:</strong> ${(doc.file_size / 1024).toFixed(1)} KB |
                            <strong>Visible au client:</strong> ${doc.is_public ? 'Oui' : 'Non'}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="icon-btn" onclick="downloadDocument('${doc.file_url}')" title="Télécharger"><span class="material-icons">download</span></button>
                        <button class="icon-btn" onclick="deleteDocument('${doc.id}')" title="Supprimer"><span class="material-icons">delete</span></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadNotes() {
            const notes = await NotesService.getByProjectId(projectId);
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                return;
            }

            container.innerHTML = '<div style="margin-top: 30px;"><h3 style="margin-bottom: 15px;">Historique des Notes</h3>' +
                notes.map(note => `
                    <div class="note-item">
                        <div class="item-content">
                            <div class="item-meta">${new Date(note.created_at).toLocaleString('fr-FR')}</div>
                            <div style="margin-top: 8px; color: #1f2937;">${note.content}</div>
                        </div>
                    </div>
                `).join('') + '</div>';
        }

        async function loadImages() {
            const images = await ProjectStore.getImages(projectId);
            const container = document.getElementById('imagesGrid');

            if (!images || images.length === 0) {
                container.innerHTML = '<div class="empty-state"><span class="material-icons">photo_library</span><p>Aucune photo</p></div>';
                return;
            }

            container.innerHTML = images.map(img => `
                <div class="image-card">
                    <img src="${img.thumbnail_url || img.url}" alt="${img.caption || 'Photo'}" onclick="openImageModal('${img.url}', '${img.caption || 'Photo'}')">
                    <div class="image-caption">
                        <span>${img.caption || 'Photo'}</span>
                        <span class="image-tag">${img.phase_name || (img.uploaded_at ? new Date(img.uploaded_at).toLocaleDateString('fr-FR') : '')}</span>
                    </div>
                    <button class="icon-btn" style="position:absolute;top:8px;right:8px;background:#fee2e2;" onclick="deleteImage('${img.id}')">
                        <span class="material-icons" style="font-size:18px;color:#991b1b;">delete</span>
                    </button>
                </div>
            `).join('');
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab')?.classList.add('active');
            document.getElementById(tab)?.classList.add('active');
        };

        window.saveProject = async function() {
            const updates = {
                name: document.getElementById('name').value,
                project_type: document.getElementById('projectTypeSelect').value,
                status: document.getElementById('status').value,
                progress: parseInt(document.getElementById('progress').value),
                description: document.getElementById('description').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                budget: parseInt(document.getElementById('budget').value),
                client_name: document.getElementById('clientNameInput').value,
                client_email: document.getElementById('clientEmail').value,
                client_phone: document.getElementById('clientPhone').value,
                project_manager: document.getElementById('projectManager').value,
                manager_email: document.getElementById('managerEmail').value
            };

            const result = await ProjectStore.update(projectId, updates);
            if (result.success) {
                alert('Projet enregistré avec succès');
                await loadProject();
            } else {
                alert('Erreur: ' + result.error);
            }
        };

        window.updateProgress = function() {
            const value = document.getElementById('progress').value;
            document.getElementById('progressValue').textContent = `${value}%`;
        };

        window.addPhaseForm = function() {
            document.getElementById('phaseFormContainer').style.display = 'block';
        };

        window.savePhase = async function() {
            const phase = {
                project_id: projectId,
                title: document.getElementById('phaseTitle').value,
                description: document.getElementById('phaseDescription').value,
                status: document.getElementById('phaseStatus').value,
                start_date: document.getElementById('phaseStartDate').value,
                end_date: document.getElementById('phaseEndDate').value,
                progress: parseInt(document.getElementById('phaseProgress').value) || 0
            };

            const result = await PhaseService.create(phase);
            if (result.success) {
                alert('Phase créée');
                document.getElementById('phaseFormContainer').style.display = 'none';
                document.getElementById('phaseTitle').value = '';
                document.getElementById('phaseDescription').value = '';
                document.getElementById('phaseProgress').value = 0;
                await loadPhases();
            } else {
                alert('Erreur: ' + result.error);
            }
        };

        window.cancelPhaseForm = function() {
            document.getElementById('phaseFormContainer').style.display = 'none';
        };

        window.deletePhase = async function(id) {
            if (confirm('Êtes-vous sûr?')) {
                const result = await PhaseService.delete(id);
                if (result.success) {
                    alert('Phase supprimée');
                    await loadPhases();
                }
            }
        };

        window.showDocumentUpload = function() {
            document.getElementById('documentFormContainer').style.display = 'block';
        };

        window.cancelDocumentForm = function() {
            document.getElementById('documentFormContainer').style.display = 'none';
        };

        document.getElementById('documentFile')?.addEventListener('change', (e) => {
            const fileName = e.target.files[0]?.name || '';
            document.getElementById('fileName').textContent = fileName;
        });

        window.uploadDocument = async function() {
            const file = document.getElementById('documentFile').files[0];
            if (!file) {
                alert('Sélectionnez un fichier');
                return;
            }

            const upload = await DocumentService.uploadFile(projectId, file);
            if (!upload.success) {
                alert('Erreur upload: ' + upload.error);
                return;
            }

            const doc = {
                project_id: projectId,
                filename: file.name,
                file_url: upload.publicUrl,
                document_type: document.getElementById('docType').value,
                title: document.getElementById('docName').value || file.name,
                file_size: file.size,
                mime_type: file.type,
                visible_to_client: document.getElementById('docVisibility').value === 'true',
                uploaded_by: AuthService.currentUser?.id || null
            };

            const result = await DocumentService.create(doc);
            if (result.success) {
                alert('Document ajouté');
                document.getElementById('documentFormContainer').style.display = 'none';
                document.getElementById('documentFile').value = '';
                document.getElementById('fileName').textContent = '';
                await loadDocuments();
            } else {
                alert('Erreur: ' + result.error);
            }
        };

        window.deleteDocument = async function(id) {
            if (confirm('Êtes-vous sûr?')) {
                const result = await DocumentService.delete(id);
                if (result.success) {
                    alert('Document supprimé');
                    await loadDocuments();
                }
            }
        };

        window.downloadDocument = async function(url) {
            const signed = await DocumentService.getSignedDownloadUrl(url);
            if (signed.success) {
                window.open(signed.url, '_blank');
            } else {
                alert('Erreur téléchargement: ' + signed.error);
            }
        };

        function resizeImage(file, maxWidth = 1920, quality = 0.88) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.onload = () => {
                        const scale = Math.min(1, maxWidth / img.width);
                        const canvas = document.createElement('canvas');
                        canvas.width = Math.round(img.width * scale);
                        canvas.height = Math.round(img.height * scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => {
                            if (!blob) return reject(new Error('Resize failed'));
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function createSquareThumbnail(file, size = 270, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        const minSide = Math.min(img.width, img.height);
                        const sx = Math.floor((img.width - minSide) / 2);
                        const sy = Math.floor((img.height - minSide) / 2);
                        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
                        canvas.toBlob((blob) => {
                            if (!blob) return reject(new Error('Thumb failed'));
                            resolve(new File([blob], `thumb_${file.name.replace(/\s+/g, '_')}.jpg`, { type: 'image/jpeg' }));
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('siteImagesInput')?.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files || []);
            if (files.length === 0) return;

            const phaseId = document.getElementById('phaseTagSelect')?.value || '';
            const phaseName = phaseOptions.find(p => p.id === phaseId)?.name || '';

            for (const file of files) {
                const fullFile = await resizeImage(file);
                const thumbFile = await createSquareThumbnail(file, 270);
                const imageObj = {
                    fullFile,
                    thumbnailFile: thumbFile,
                    caption: file.name.replace(/\.[^/.]+$/, ''),
                    src: '',
                    phase_id: phaseId || null,
                    phase_name: phaseName || null
                };
                await ProjectStore.addImage(projectId, imageObj);
            }

            e.target.value = '';
            await loadImages();
        });

        window.deleteImage = async function(imageId) {
            if (!confirm('Supprimer cette image ?')) return;
            const result = await ProjectStore.deleteImage(imageId);
            if (!result.success) {
                alert('Erreur suppression: ' + result.error);
                return;
            }
            await loadImages();
        };

        window.openImageModal = function(url, caption) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('imageModalImg');
            const title = document.getElementById('imageModalTitle');
            img.src = url;
            title.textContent = caption || 'Photo';
            modal.classList.add('open');
        };

        window.closeImageModal = function() {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('imageModalImg');
            img.src = '';
            modal.classList.remove('open');
        };

        window.downloadImage = function() {
            const url = document.getElementById('imageModalImg').src;
            if (!url) return;
            const link = document.createElement('a');
            link.href = url;
            link.download = 'photo-chantier.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        async function autoSaveNotes() {
            const content = document.getElementById('internalNotes').value;
            if (!content.trim()) return;

            const result = await NotesService.create({
                project_id: projectId,
                content: content,
                created_by: AuthService.currentUser?.id
            });

            if (result.success) {
                await loadNotes();
            }
        }

        window.regeneratePin = function() {
            const pin = Math.floor(Math.random() * 900000) + 100000;
            document.getElementById('pinDisplay').textContent = pin;
        };

        window.copyPin = function() {
            const pin = document.getElementById('pinDisplay').textContent;
            navigator.clipboard.writeText(pin).then(() => {
                alert('PIN copié: ' + pin);
            });
        };

        window.logout = async function() {
            if (confirm('Déconnecter?')) {
                await AuthService.logout();
                window.location.href = 'login.html';
            }
        };

        window.addEventListener('load', initialize);
    </script>

    <div id="imageModal" class="image-modal" onclick="if (event.target.id === 'imageModal') closeImageModal()">
        <div class="image-modal-content">
            <img id="imageModalImg" src="" alt="Photo">
            <div class="image-modal-actions">
                <div class="title" id="imageModalTitle">Photo</div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="downloadImage()"><span class="material-icons">download</span>Télécharger</button>
                    <button class="btn btn-secondary" onclick="closeImageModal()"><span class="material-icons">close</span>Fermer</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
