<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier - TDE Group Admin</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="./styles/admin-layout.css">
    <style>
        .calendar-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .month-nav {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 8px 12px;
        }

        .month-nav button {
            border: none;
            background: #f1f5f9;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            cursor: pointer;
            color: #0d9488;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .month-nav h2 {
            margin: 0;
            min-width: 210px;
            text-align: center;
            font-size: 1.05rem;
            color: #1f2937;
            text-transform: capitalize;
        }

        .calendar-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fff;
            color: #334155;
            padding: 8px 12px;
            cursor: pointer;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            font-weight: 600;
        }

        .btn.primary {
            background: linear-gradient(135deg, #0d9488, #0f766e);
            color: #fff;
            border: none;
        }

        .calendar-layout {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 16px;
        }

        .calendar-panel,
        .events-panel,
        .event-form-panel {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
        }

        .week-header {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px;
            margin-bottom: 1px;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }

        .week-day {
            background: #64748b;
            color: #fff;
            text-align: center;
            padding: 10px;
            font-size: 12px;
            font-weight: 700;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 1px;
            border: 1px solid #e5e7eb;
            background: #e5e7eb;
            border-radius: 0 0 10px 10px;
            overflow: hidden;
        }

        .calendar-day {
            background: #fff;
            min-height: 116px;
            padding: 10px;
            cursor: pointer;
        }

        .calendar-day:hover {
            background: #f8fafc;
        }

        .calendar-day.other-month {
            background: #f8fafc;
            color: #94a3b8;
        }

        .calendar-day.today {
            box-shadow: inset 0 0 0 2px #0d9488;
        }

        .calendar-day.selected {
            box-shadow: inset 0 0 0 2px #3b82f6;
        }

        .day-number {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-pill {
            font-size: 11px;
            border-radius: 6px;
            padding: 3px 6px;
            line-height: 1.2;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            border: 1px solid transparent;
        }

        .event-pill.user.high { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .event-pill.user.medium { background: #fef3c7; color: #92400e; border-color: #fde68a; }
        .event-pill.user.low { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
        .event-pill.project { background: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; }

        .panel-title {
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
            font-size: 1rem;
        }

        .event-form {
            display: grid;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .event-form input,
        .event-form select,
        .event-form textarea {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 13px;
            outline: none;
        }

        .event-form textarea {
            min-height: 64px;
            resize: vertical;
        }

        .event-form input:focus,
        .event-form select:focus,
        .event-form textarea:focus {
            border-color: #0d9488;
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.15);
        }

        .event-form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            max-height: 520px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .event-card {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            background: #fff;
            border-left: 4px solid #0d9488;
        }

        .event-card.project {
            border-left-color: #3b82f6;
        }

        .event-card-head {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: flex-start;
        }

        .event-meta {
            color: #64748b;
            font-size: 12px;
            margin-top: 3px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .event-reminder-note {
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 700;
            color: #b91c1c;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 999px;
            padding: 4px 10px;
        }

        .event-title {
            margin: 0;
            color: #0f172a;
            font-size: 14px;
            font-weight: 700;
        }

        .event-actions {
            display: inline-flex;
            gap: 6px;
        }

        .icon-btn {
            border: 1px solid #e5e7eb;
            background: #fff;
            border-radius: 8px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            color: #64748b;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .icon-btn:hover { border-color: #0d9488; color: #0d9488; }
        .icon-btn.delete:hover { border-color: #ef4444; color: #ef4444; }

        .empty {
            padding: 16px;
            text-align: center;
            color: #94a3b8;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
        }

        @media (max-width: 1100px) {
            .calendar-layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 680px) {
            .form-row { grid-template-columns: 1fr; }
            .month-nav h2 { min-width: 160px; font-size: 0.95rem; }
            .calendar-day { min-height: 92px; padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo"><img src="../logo.png" alt="TDE Group"><div class="logo-text"><span>TDE GROUP</span><small>TOGETHER WE MAKE IT!</small></div></div>
        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item"><span class="material-icons">dashboard</span><span>Dashboard</span></a>
            <a href="create-project.html" class="sidebar-item"><span class="material-icons">add_circle</span><span>Nouveau Projet</span></a>
            <a href="clients.html" class="sidebar-item"><span class="material-icons">groups</span><span>Clients (CRM)</span></a>
            <a href="tickets.html" class="sidebar-item"><span class="material-icons">support_agent</span><span>Support</span></a>
            <a href="messages.html" class="sidebar-item"><span class="material-icons">mail</span><span>Messages</span></a>
            <a href="calendar.html" class="sidebar-item active"><span class="material-icons">calendar_today</span><span>Calendrier</span></a>
            <a href="reports.html" class="sidebar-item"><span class="material-icons">assessment</span><span>Rapports</span></a>
            <a href="profile.html" class="sidebar-item"><span class="material-icons">account_circle</span><span>Profil</span></a>
            <a href="../client/login.html" class="sidebar-item" target="_blank" rel="noopener"><span class="material-icons">visibility</span><span>My Project (Client)</span></a>
            <div class="sidebar-logout">
                <button class="sidebar-item" onclick="logout()"><span class="material-icons">logout</span><span>Déconnexion</span></button>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-title"><span class="material-icons">calendar_today</span><span>Calendrier</span></div>
            <div class="header-right">
                <div class="search-box"><span class="material-icons">search</span><input type="text" id="searchInput" placeholder="Rechercher un événement..."></div>
                <div class="user-profile"><div class="user-avatar" id="userInitials">AD</div></div>
            </div>
        </div>

        <div class="content">
            <div class="page-header">
                <h1>Calendrier des Projets</h1>
                <div class="calendar-actions">
                    <button class="btn" id="todayBtn" type="button"><span class="material-icons">today</span>Aujourd'hui</button>
                    <button class="btn primary" id="newEventBtn" type="button"><span class="material-icons">add</span>Nouvel événement</button>
                </div>
            </div>

            <div class="calendar-toolbar">
                <div class="month-nav">
                    <button id="prevMonthBtn" type="button" aria-label="Mois précédent"><span class="material-icons">chevron_left</span></button>
                    <h2 id="monthYear"></h2>
                    <button id="nextMonthBtn" type="button" aria-label="Mois suivant"><span class="material-icons">chevron_right</span></button>
                </div>
                <a class="btn" href="index.html"><span class="material-icons">dashboard</span>Retour Dashboard</a>
            </div>

            <div class="calendar-layout">
                <section class="calendar-panel">
                    <div class="week-header">
                        <div class="week-day">Lun</div>
                        <div class="week-day">Mar</div>
                        <div class="week-day">Mer</div>
                        <div class="week-day">Jeu</div>
                        <div class="week-day">Ven</div>
                        <div class="week-day">Sam</div>
                        <div class="week-day">Dim</div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </section>

                <section>
                    <div class="event-form-panel">
                        <h3 class="panel-title"><span class="material-icons">event</span><span id="formTitle">Nouvel événement</span></h3>
                        <form id="eventForm" class="event-form">
                            <input type="hidden" id="eventId">
                            <div>
                                <input type="text" id="eventTitle" placeholder="Titre de l'événement" required>
                            </div>
                            <div class="form-row">
                                <input type="date" id="eventDate" required>
                                <input type="time" id="eventTime">
                            </div>
                            <div class="form-row">
                                <select id="eventPriority">
                                    <option value="high">Priorité haute</option>
                                    <option value="medium" selected>Priorité moyenne</option>
                                    <option value="low">Priorité basse</option>
                                </select>
                                <select id="eventType">
                                    <option value="meeting">Réunion</option>
                                    <option value="delivery">Livraison</option>
                                    <option value="deadline">Deadline</option>
                                    <option value="task">Tâche</option>
                                    <option value="general" selected>Général</option>
                                </select>
                            </div>
                            <div>
                                <select id="eventProjectId">
                                    <option value="">Sans projet associé</option>
                                </select>
                            </div>
                            <div>
                                <textarea id="eventNotes" placeholder="Notes (optionnel)"></textarea>
                            </div>
                            <div class="event-form-actions">
                                <button type="button" class="btn" id="cancelEditBtn">Annuler</button>
                                <button type="submit" class="btn primary"><span class="material-icons">save</span>Enregistrer</button>
                            </div>
                        </form>
                    </div>

                    <div class="events-panel" style="margin-top: 12px;">
                        <h3 class="panel-title"><span class="material-icons">event_note</span>Événements à venir</h3>
                        <div id="eventsList" class="events-list"></div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script type="module">
        import authService from '../src/auth-service.js';
        import { initAdminAvatar } from '../src/admin-avatar.js';
        import ProjectStore from '../src/data-store.js';
        import adminEventsService from '../src/admin-events-service.js';

        let currentDate = new Date();
        let selectedDateKey = null;
        let projects = [];
        let userEvents = [];
        let unsubscribeEvents = null;

        const dom = {
            monthYear: document.getElementById('monthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            eventsList: document.getElementById('eventsList'),
            searchInput: document.getElementById('searchInput'),
            formTitle: document.getElementById('formTitle'),
            eventForm: document.getElementById('eventForm'),
            eventId: document.getElementById('eventId'),
            eventTitle: document.getElementById('eventTitle'),
            eventDate: document.getElementById('eventDate'),
            eventTime: document.getElementById('eventTime'),
            eventPriority: document.getElementById('eventPriority'),
            eventType: document.getElementById('eventType'),
            eventProjectId: document.getElementById('eventProjectId'),
            eventNotes: document.getElementById('eventNotes'),
            cancelEditBtn: document.getElementById('cancelEditBtn'),
            todayBtn: document.getElementById('todayBtn'),
            newEventBtn: document.getElementById('newEventBtn'),
            prevMonthBtn: document.getElementById('prevMonthBtn'),
            nextMonthBtn: document.getElementById('nextMonthBtn')
        };

        function dateKeyFromDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function eventDateTime(event) {
            return new Date(`${event.date}T${event.time || '00:00'}:00`);
        }

        function priorityLabel(priority) {
            if (priority === 'high') return 'Haute';
            if (priority === 'low') return 'Basse';
            return 'Moyenne';
        }

        function typeLabel(type) {
            const map = {
                meeting: 'Réunion',
                delivery: 'Livraison',
                deadline: 'Deadline',
                task: 'Tâche',
                general: 'Général',
                project: 'Projet'
            };
            return map[type] || 'Général';
        }

        function projectNameById(id) {
            return projects.find((p) => String(p.id) === String(id))?.name || null;
        }

        function deadlineReminder(dateValue) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const d = new Date(dateValue);
            const start = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const days = Math.floor((start - startOfToday) / (24 * 60 * 60 * 1000));
            if (days < 0) return `Délai dépassé (${Math.abs(days)}j)`;
            if (days === 0) return 'Deadline aujourd\'hui';
            if (days <= 3) return `Rappel auto J-${days}`;
            return '';
        }

        function buildProjectMilestones() {
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);

            return (projects || []).flatMap((project) => {
                const items = [];
                if (project.start_date) {
                    const d = new Date(project.start_date);
                    if (!Number.isNaN(d.getTime()) && d >= lastMonth) {
                        items.push({
                            id: `project-start-${project.id}`,
                            date: dateKeyFromDate(d),
                            time: '',
                            title: `Démarrage: ${project.name || 'Projet'}`,
                            priority: 'medium',
                            type: 'project',
                            projectId: project.id,
                            projectName: project.name || 'Projet',
                            notes: 'Date de début projet',
                            readonly: true
                        });
                    }
                }
                if (project.end_date) {
                    const d = new Date(project.end_date);
                    if (!Number.isNaN(d.getTime()) && d >= lastMonth) {
                        const status = (project.status || '').toLowerCase();
                        items.push({
                            id: `project-end-${project.id}`,
                            date: dateKeyFromDate(d),
                            time: '',
                            title: `Échéance: ${project.name || 'Projet'}`,
                            priority: ['completed', 'cancelled'].includes(status) ? 'low' : 'high',
                            type: 'project',
                            projectId: project.id,
                            projectName: project.name || 'Projet',
                            notes: 'Date de fin projet',
                            readonly: true
                        });
                    }
                }
                return items;
            });
        }

        function getAllRenderableEvents() {
            const normalizedUserEvents = userEvents.map((event) => ({ ...event, source: 'user', readonly: false }));
            const projectEvents = buildProjectMilestones().map((event) => ({ ...event, source: 'project', readonly: true }));
            return [...normalizedUserEvents, ...projectEvents].sort((a, b) => eventDateTime(a) - eventDateTime(b));
        }

        async function refreshUserEvents() {
            try {
                userEvents = await adminEventsService.getAll();
            } catch (error) {
                console.error('refreshUserEvents error:', error);
                userEvents = [];
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            dom.monthYear.textContent = currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const monthDays = new Date(year, month + 1, 0).getDate();
            const leadingDays = (firstDay.getDay() + 6) % 7;

            const eventsByDate = getAllRenderableEvents().reduce((acc, event) => {
                const key = event.date;
                if (!acc[key]) acc[key] = [];
                acc[key].push(event);
                return acc;
            }, {});

            dom.calendarGrid.innerHTML = '';

            for (let i = leadingDays - 1; i >= 0; i--) {
                const prev = new Date(year, month, -i);
                dom.calendarGrid.appendChild(buildDayCell(prev, true, eventsByDate[dateKeyFromDate(prev)] || []));
            }

            for (let day = 1; day <= monthDays; day++) {
                const date = new Date(year, month, day);
                dom.calendarGrid.appendChild(buildDayCell(date, false, eventsByDate[dateKeyFromDate(date)] || []));
            }

            const filled = leadingDays + monthDays;
            const trailingDays = (7 - (filled % 7)) % 7;
            for (let day = 1; day <= trailingDays; day++) {
                const next = new Date(year, month + 1, day);
                dom.calendarGrid.appendChild(buildDayCell(next, true, eventsByDate[dateKeyFromDate(next)] || []));
            }
        }

        function buildDayCell(date, otherMonth, events) {
            const key = dateKeyFromDate(date);
            const todayKey = dateKeyFromDate(new Date());
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            if (otherMonth) dayDiv.classList.add('other-month');
            if (key === todayKey) dayDiv.classList.add('today');
            if (key === selectedDateKey) dayDiv.classList.add('selected');
            dayDiv.dataset.date = key;

            const maxVisible = 3;
            const shown = events.slice(0, maxVisible).map((event) => {
                const cls = event.source === 'project' ? 'project' : `user ${event.priority || 'medium'}`;
                const time = event.time ? `${event.time} ` : '';
                return `<div class="event-pill ${cls}" title="${escapeHtml(event.title)}">${escapeHtml(`${time}${event.title}`)}</div>`;
            }).join('');

            const more = events.length > maxVisible
                ? `<div class="event-pill project">+${events.length - maxVisible} autre(s)</div>`
                : '';

            dayDiv.innerHTML = `
                <div class="day-number">${date.getDate()}</div>
                <div class="day-events">${shown}${more}</div>
            `;

            dayDiv.addEventListener('click', () => {
                selectedDateKey = key;
                dom.eventDate.value = key;
                renderCalendar();
                renderUpcomingEvents();
            });

            return dayDiv;
        }

        function renderUpcomingEvents() {
            const query = (dom.searchInput.value || '').trim().toLowerCase();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            const events = getAllRenderableEvents().filter((event) => {
                const dateObj = eventDateTime(event);
                const matchesMonth = dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear;
                const matchesSearch = !query || `${event.title} ${event.notes || ''} ${event.projectName || ''}`.toLowerCase().includes(query);
                const matchesSelected = !selectedDateKey || event.date === selectedDateKey;
                return matchesMonth && matchesSearch && matchesSelected;
            }).map((event) => {
                const isDeadline = event.source === 'project' || String(event.type || '').toLowerCase() === 'deadline';
                return { ...event, reminder: isDeadline ? deadlineReminder(event.date) : '' };
            });

            if (!events.length) {
                dom.eventsList.innerHTML = '<div class="empty"><span class="material-icons" style="font-size:34px;display:block;margin-bottom:8px;">event_busy</span>Aucun événement pour ce filtre.</div>';
                return;
            }

            dom.eventsList.innerHTML = events.map((event) => {
                const dateLabel = new Date(`${event.date}T${event.time || '00:00'}:00`).toLocaleDateString('fr-FR', {
                    weekday: 'short',
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                const projectLabel = event.projectId ? (event.projectName || projectNameById(event.projectId) || 'Projet') : null;

                return `
                    <article class="event-card ${event.source === 'project' ? 'project' : ''}">
                        <div class="event-card-head">
                            <div>
                                <h4 class="event-title">${escapeHtml(event.title)}</h4>
                                <div class="event-meta">
                                    <span><span class="material-icons" style="font-size:12px;vertical-align:middle;">event</span> ${dateLabel}${event.time ? ` • ${event.time}` : ''}</span>
                                    <span>${typeLabel(event.type)}</span>
                                    <span>Priorité ${priorityLabel(event.priority)}</span>
                                    ${projectLabel ? `<span>Projet: ${escapeHtml(projectLabel)}</span>` : ''}
                                </div>
                                ${event.notes ? `<div class="event-meta">${escapeHtml(event.notes)}</div>` : ''}
                                ${event.reminder ? `<p class="event-reminder-note"><span class="material-icons" style="font-size:14px;">notifications_active</span>${escapeHtml(event.reminder)}</p>` : ''}
                            </div>
                            ${event.readonly ? '' : `
                                <div class="event-actions">
                                    <button class="icon-btn" type="button" data-action="edit" data-id="${event.id}" title="Modifier"><span class="material-icons" style="font-size:16px;">edit</span></button>
                                    <button class="icon-btn delete" type="button" data-action="delete" data-id="${event.id}" title="Supprimer"><span class="material-icons" style="font-size:16px;">delete</span></button>
                                </div>
                            `}
                        </div>
                    </article>
                `;
            }).join('');

            dom.eventsList.querySelectorAll('button[data-action="edit"]').forEach((btn) => {
                btn.addEventListener('click', () => startEditEvent(btn.dataset.id));
            });

            dom.eventsList.querySelectorAll('button[data-action="delete"]').forEach((btn) => {
                btn.addEventListener('click', () => deleteEvent(btn.dataset.id));
            });
        }

        function resetForm(defaultDate = null) {
            dom.formTitle.textContent = 'Nouvel événement';
            dom.eventId.value = '';
            dom.eventTitle.value = '';
            dom.eventDate.value = defaultDate || selectedDateKey || dateKeyFromDate(new Date());
            dom.eventTime.value = '';
            dom.eventPriority.value = 'medium';
            dom.eventType.value = 'general';
            dom.eventProjectId.value = '';
            dom.eventNotes.value = '';
        }

        function startEditEvent(id) {
            const event = userEvents.find((item) => String(item.id) === String(id));
            if (!event) return;
            dom.formTitle.textContent = 'Modifier événement';
            dom.eventId.value = event.id;
            dom.eventTitle.value = event.title || '';
            dom.eventDate.value = event.date || '';
            dom.eventTime.value = event.time || '';
            dom.eventPriority.value = event.priority || 'medium';
            dom.eventType.value = event.type || 'general';
            dom.eventProjectId.value = event.projectId || '';
            dom.eventNotes.value = event.notes || '';
            selectedDateKey = event.date;
            renderCalendar();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteEvent(id) {
            if (!window.confirm('Supprimer cet événement ?')) return;
            try {
                await adminEventsService.remove(id);
                await refreshUserEvents();
                if (dom.eventId.value === id) {
                    resetForm();
                }
                renderCalendar();
                renderUpcomingEvents();
            } catch (error) {
                alert(error.message || 'Impossible de supprimer l\'événement.');
            }
        }

        function populateProjectOptions() {
            const options = ['<option value="">Sans projet associé</option>']
                .concat(projects.map((project) => `<option value="${project.id}">${escapeHtml(project.name || 'Projet')}</option>`));
            dom.eventProjectId.innerHTML = options.join('');
        }

        function bindEvents() {
            dom.prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                selectedDateKey = null;
                renderCalendar();
                renderUpcomingEvents();
            });

            dom.nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                selectedDateKey = null;
                renderCalendar();
                renderUpcomingEvents();
            });

            dom.todayBtn.addEventListener('click', () => {
                currentDate = new Date();
                selectedDateKey = dateKeyFromDate(new Date());
                renderCalendar();
                renderUpcomingEvents();
            });

            dom.newEventBtn.addEventListener('click', () => {
                resetForm(selectedDateKey || dateKeyFromDate(new Date()));
                dom.eventTitle.focus();
            });

            dom.cancelEditBtn.addEventListener('click', () => {
                resetForm(selectedDateKey || dateKeyFromDate(new Date()));
            });

            dom.searchInput.addEventListener('input', () => renderUpcomingEvents());

            dom.eventForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const payload = {
                    title: dom.eventTitle.value,
                    date: dom.eventDate.value,
                    time: dom.eventTime.value,
                    priority: dom.eventPriority.value,
                    type: dom.eventType.value,
                    projectId: dom.eventProjectId.value || null,
                    notes: dom.eventNotes.value
                };

                try {
                    if (dom.eventId.value) {
                        await adminEventsService.update(dom.eventId.value, payload);
                    } else {
                        await adminEventsService.create(payload);
                    }
                    await refreshUserEvents();
                    selectedDateKey = payload.date;
                    resetForm(payload.date);
                    renderCalendar();
                    renderUpcomingEvents();
                } catch (error) {
                    alert(error.message || 'Impossible d\'enregistrer l\'événement.');
                }
            });
        }

        function applyDraftFromUrl(params) {
            const draftTitle = (params.get('draft') || '').trim();
            const draftType = (params.get('type') || '').trim().toLowerCase();
            const draftProject = (params.get('project') || '').trim();
            const draftNotes = (params.get('notes') || '').trim();

            const hasDraft = Boolean(draftTitle || draftType || draftProject || draftNotes);
            if (!hasDraft) return;

            if (draftTitle) dom.eventTitle.value = draftTitle;
            if (draftType && Array.from(dom.eventType.options).some((o) => o.value === draftType)) {
                dom.eventType.value = draftType;
            }
            if (draftProject && Array.from(dom.eventProjectId.options).some((o) => o.value === draftProject)) {
                dom.eventProjectId.value = draftProject;
            }
            if (draftNotes) dom.eventNotes.value = draftNotes;
            dom.formTitle.textContent = 'Nouvel événement (pré-rempli)';
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        window.logout = async () => {
            if (!window.confirm('Déconnecter ?')) return;
            await authService.logout();
            window.location.href = 'login.html';
        };

        window.addEventListener('load', async () => {
            try {
                await authService.authReady;
                if (!authService.isAdmin || !authService.isAdmin()) {
                    window.location.href = 'login.html';
                    return;
                }

                await initAdminAvatar();
                projects = await ProjectStore.getAll();
                populateProjectOptions();
                bindEvents();
                const params = new URLSearchParams(window.location.search);
                const requestedDate = (params.get('date') || '').trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(requestedDate)) {
                    selectedDateKey = requestedDate;
                    currentDate = new Date(`${requestedDate}T00:00:00`);
                } else {
                    selectedDateKey = dateKeyFromDate(new Date());
                }
                await refreshUserEvents();
                unsubscribeEvents = adminEventsService.subscribe(async () => {
                    await refreshUserEvents();
                    renderCalendar();
                    renderUpcomingEvents();
                });
                resetForm(selectedDateKey);
                applyDraftFromUrl(params);
                renderCalendar();
                renderUpcomingEvents();
            } catch (error) {
                console.error('Calendar init error:', error);
                window.location.href = 'login.html';
            }
        });

        window.addEventListener('beforeunload', () => {
            try {
                unsubscribeEvents?.();
            } catch (error) {
                console.error('calendar unsubscribe error:', error);
            }
        });
    </script>
</body>
</html>
