<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - TDE Group Admin</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="./styles/admin-layout.css">
    <style>
        .profile-container { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; max-width: 1000px; }
        .profile-card { background: white; border-radius: 8px; padding: 30px; text-align: center; }
        .profile-avatar { width: 120px; height: 120px; background: linear-gradient(135deg, #0d9488, #14b8a6); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; margin: 0 auto 20px; }
        .profile-name { font-size: 22px; font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .profile-email { color: #6b7280; margin-bottom: 20px; }
        .profile-badge { display: inline-block; background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 20px; font-size: 14px; font-weight: 500; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; color: #1f2937; margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: #0d9488; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .form-section { background: white; border-radius: 8px; padding: 30px; margin-bottom: 20px; }
        .form-section h3 { margin: 0 0 20px 0; color: #1f2937; border-bottom: 2px solid #0d9488; padding-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-save { background: #0d9488; color: white; }
        .btn-save:hover { background: #0f766e; }
        .btn-cancel { background: #e5e7eb; color: #1f2937; }
        .btn-cancel:hover { background: #d1d5db; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-logo"><img src="../logo.png" alt="TDE Group"><div class="logo-text"><span>TDE GROUP</span><small>TOGETHER WE MAKE IT!</small></div></div>
        <nav class="sidebar-menu">
            <a href="index.html" class="sidebar-item"><span class="material-icons">dashboard</span><span>Dashboard</span></a>
            <a href="create-project.html" class="sidebar-item"><span class="material-icons">add_circle</span><span>Nouveau Projet</span></a>
            <a href="clients.html" class="sidebar-item"><span class="material-icons">groups</span><span>Clients (CRM)</span></a>
            <a href="tickets.html" class="sidebar-item"><span class="material-icons">support_agent</span><span>Support</span></a>
            <a href="messages.html" class="sidebar-item"><span class="material-icons">mail</span><span>Messages</span></a>
            <a href="calendar.html" class="sidebar-item"><span class="material-icons">calendar_today</span><span>Calendrier</span></a>
            <a href="reports.html" class="sidebar-item"><span class="material-icons">assessment</span><span>Rapports</span></a>
            <a href="profile.html" class="sidebar-item active"><span class="material-icons">account_circle</span><span>Profil</span></a>
            <a href="../my-project.html" class="sidebar-item" target="_blank" rel="noopener"><span class="material-icons">visibility</span><span>My Project (Client)</span></a>
            <div class="sidebar-logout">
                <button class="sidebar-item" onclick="logout()"><span class="material-icons">logout</span><span>Déconnexion</span></button>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="header-title"><span class="material-icons">account_circle</span><span>Mon Profil</span></div>
            <div class="header-right">
                <div class="search-box"><span class="material-icons">search</span><input type="text" id="searchInput" placeholder="Rechercher..."></div>
                <div class="user-profile"><div class="user-avatar" id="userInitials">AD</div></div>
            </div>
        </div>

        <div class="content">
            <div class="page-header">
                <h1>Paramètres du Profil</h1>
            </div>

            <div class="profile-container">
                <div class="profile-card">
                    <div class="profile-avatar" id="profileAvatar">AD</div>
                    <input type="file" id="photoInput" accept="image/*" style="display:none;">
                    <button class="btn-save" style="margin: 10px auto 0; display:block; width: fit-content;" onclick="document.getElementById('photoInput').click()">
                        <span class="material-icons" style="font-size:18px; vertical-align: middle;">photo_camera</span> Changer la photo
                    </button>
                    <h2 class="profile-name" id="profileName">Admin User</h2>
                    <p class="profile-email" id="profileEmail">admin@tdegroup.com</p>
                    <span class="profile-badge">Administrateur</span>
                </div>

                <div>
                    <div class="form-section">
                        <h3><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">edit</span>Informations Personnelles</h3>
                        <div class="form-group">
                            <label>Prénom</label>
                            <input type="text" id="firstName" placeholder="Prénom">
                        </div>
                        <div class="form-group">
                            <label>Nom</label>
                            <input type="text" id="lastName" placeholder="Nom">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label>Téléphone</label>
                            <input type="tel" id="phone" placeholder="+225 01 23 45 67 89">
                        </div>
                        <div class="form-group">
                            <label>Ville</label>
                            <input type="text" id="city" placeholder="Ville">
                        </div>
                        <div class="btn-group">
                            <button class="btn-save" onclick="saveProfile()"><span class="material-icons">check</span>Enregistrer</button>
                            <button class="btn-cancel" onclick="resetForm()"><span class="material-icons">close</span>Annuler</button>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><span class="material-icons" style="vertical-align: middle; margin-right: 10px;">lock</span>Sécurité</h3>
                        <div class="form-group">
                            <label>Mot de passe actuel</label>
                            <input type="password" id="currentPassword" placeholder="Entrez votre mot de passe">
                        </div>
                        <div class="form-group">
                            <label>Nouveau mot de passe</label>
                            <input type="password" id="newPassword" placeholder="Nouveau mot de passe">
                        </div>
                        <div class="form-group">
                            <label>Confirmer le mot de passe</label>
                            <input type="password" id="confirmPassword" placeholder="Confirmez le mot de passe">
                        </div>
                        <div class="btn-group">
                            <button class="btn-save" onclick="changePassword()"><span class="material-icons">check</span>Mettre à jour</button>
                            <button class="btn-cancel" onclick="resetPasswordForm()"><span class="material-icons">close</span>Annuler</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import authService from '../src/auth-service.js';
        import ProfileService from '../src/profile-service.js';
        import { initAdminAvatar } from '../src/admin-avatar.js';

        window.addEventListener('load', async () => {
            try {
                await authService.authReady;
                if (!authService.currentUser) window.location.href = 'login.html';
                await initAdminAvatar();
                await loadProfile();
            } catch (error) {
                window.location.href = 'login.html';
            }
        });

        async function loadProfile() {
            const profile = await ProfileService.getAdminProfile();
            const name = profile.name || '';
            const parts = name.split(' ');
            const firstName = profile.first_name || parts.slice(0, -1).join(' ') || name;
            const lastName = profile.last_name || parts.slice(-1).join(' ');

            document.getElementById('profileName').textContent = name || 'Admin';
            document.getElementById('profileEmail').textContent = profile.email || authService.currentUser.email;
            document.getElementById('email').value = profile.email || authService.currentUser.email;
            document.getElementById('firstName').value = firstName || '';
            document.getElementById('lastName').value = lastName || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('city').value = profile.city || '';

            if (profile.photo_url) {
                document.getElementById('profileAvatar').innerHTML = `<img src="${profile.photo_url}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">`;
            } else {
                document.getElementById('profileAvatar').textContent = (firstName || 'AD').substring(0, 2).toUpperCase();
            }
        }

        document.getElementById('photoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const userId = authService.currentUser?.id;
                if (!userId) throw new Error('Utilisateur non authentifié');
                const publicUrl = await ProfileService.uploadProfilePhoto(file, userId);
                document.getElementById('profileAvatar').innerHTML = `<img src="${publicUrl}" style="width:120px;height:120px;border-radius:50%;object-fit:cover;">`;
                await initAdminAvatar();
            } catch (err) {
                alert('Erreur upload photo: ' + err.message);
            }
        });

        window.saveProfile = async () => {
            try {
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const name = `${firstName} ${lastName}`.trim();
                const updates = {
                    name,
                    first_name: firstName,
                    last_name: lastName,
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    city: document.getElementById('city').value.trim()
                };
                await ProfileService.updateAdminProfile(updates);
                document.getElementById('profileName').textContent = name || 'Admin';
                document.getElementById('profileEmail').textContent = updates.email;
                alert('Profil mis à jour');
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        };

        window.resetForm = () => {
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('city').value = '';
        };

        window.changePassword = () => alert('Mot de passe changé');
        window.resetPasswordForm = () => { 
            document.getElementById('currentPassword').value = ''; 
            document.getElementById('newPassword').value = ''; 
            document.getElementById('confirmPassword').value = ''; 
        };
        window.logout = async () => {
            if (confirm('Déconnecter?')) {
                await authService.logout();
                window.location.href = 'login.html';
            }
        };
    </script>
</body>
</html>
