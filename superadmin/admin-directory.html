<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Répertoire Admin - Superadmin</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --bg:#f4f7fb; --surface:#fff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#0d9488; --radius:16px; --shadow:0 14px 32px rgba(15,23,42,.08); }
    * { box-sizing:border-box; }
    body.auth-pending { visibility:hidden; }
    body { margin:0; font-family:'Outfit',sans-serif; color:var(--text); background:var(--bg); }
    .app { display:grid; grid-template-columns:260px 1fr; min-height:100vh; }
    .side { background:linear-gradient(165deg,#0f172a 0%,#1e293b 45%,#0d9488 100%); color:#fff; padding:22px 16px; }
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .brand-logo { width:34px; height:34px; border-radius:10px; background:rgba(255,255,255,.16); display:grid; place-items:center; font-weight:800; }
    .scope-pill { display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(255,255,255,.25); border-radius:999px; padding:6px 10px; font-size:12px; margin-bottom:16px; }
    .nav { display:grid; gap:8px; }
    .nav a, .nav button { all:unset; cursor:pointer; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:rgba(255,255,255,.92); border:1px solid transparent; }
    .nav a:hover, .nav .active, .nav button:hover { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.2); }
    .main { padding:20px; display:grid; gap:12px; align-content:start; }
    .card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
    .topbar { padding:14px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .topbar h1 { margin:0; font-size:1.2rem; font-family:'Space Grotesk',sans-serif; }
    .btn { border:1px solid var(--border); border-radius:10px; background:#fff; color:#334155; font-weight:700; padding:8px 12px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .btn.primary { border:none; color:#fff; background:linear-gradient(135deg,var(--accent),#0f766e); }
    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px; }
    .kpi { padding:12px; }
    .kpi .label { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
    .kpi .value { font-size:26px; font-weight:800; font-family:'Space Grotesk',sans-serif; }
    .filters { padding:12px; display:flex; gap:8px; flex-wrap:wrap; }
    .filters input, .filters select { border:1px solid var(--border); border-radius:10px; padding:9px 10px; font-family:inherit; }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; }
    th { font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
    .role { display:inline-flex; border-radius:999px; padding:2px 9px; font-size:11px; font-weight:700; border:1px solid transparent; }
    .role.admin { background:#dbeafe; color:#1d4ed8; border-color:#bfdbfe; }
    .role.superadmin { background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .icon-btn { border:1px solid var(--border); border-radius:10px; background:#fff; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; }
    .icon-btn:hover { border-color:var(--accent); color:var(--accent); }
    .modal { position:fixed; inset:0; background:rgba(15,23,42,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000; }
    .modal.open { display:flex; }
    .modal-card { width:min(560px, 100%); background:#fff; border-radius:14px; border:1px solid var(--border); box-shadow:0 28px 45px rgba(15,23,42,.25); overflow:hidden; }
    .modal-head { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    .modal-body { padding:14px; display:grid; gap:10px; }
    .modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .modal-field { display:grid; gap:6px; }
    .modal-field label { font-size:12px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.05em; }
    .modal-field input, .modal-field select { border:1px solid var(--border); border-radius:10px; padding:9px 10px; font-family:inherit; }
    .modal-foot { padding:12px 14px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }
    .empty { padding:14px; color:var(--muted); }
    .muted { color:var(--muted); }
    @media (max-width:980px){ .app{grid-template-columns:1fr;} .modal-grid{grid-template-columns:1fr;} }
  </style>
</head>
<body class="auth-pending">
  <div class="app">
    <aside class="side">
      <div class="brand"><div class="brand-logo">TDE</div><strong>TDE GROUP</strong></div>
      <div class="scope-pill"><span class="material-icons">shield</span><span>Super Admin Zone</span></div>
      <nav class="nav">
        <a href="dashboard.html"><span class="material-icons">dashboard</span><span>Control Room</span></a>
        <a href="create-admin.html"><span class="material-icons">person_add</span><span>Créer Admin</span></a>
        <a href="admin-directory.html" class="active"><span class="material-icons">manage_accounts</span><span>Répertoire Admin</span></a>
        <a href="admin-actions.html"><span class="material-icons">history</span><span>Actions Admin</span></a>
        <a href="users-directory.html"><span class="material-icons">badge</span><span>Répertoire Users</span></a>
        <button type="button" id="logoutBtn"><span class="material-icons">logout</span><span>Déconnexion</span></button>
      </nav>
    </aside>

    <main class="main">
      <section class="topbar card">
        <div>
          <h1>Répertoire Admins</h1>
          <div class="muted" id="lastSync">Dernière synchronisation: —</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="refreshBtn" class="btn primary"><span class="material-icons">refresh</span>Rafraîchir</button>
          <button id="exportCsvBtn" class="btn"><span class="material-icons">download</span>CSV</button>
        </div>
      </section>

      <section class="kpis">
        <article class="card kpi"><div class="label">Total admins</div><div class="value" id="kpiTotal">0</div></article>
        <article class="card kpi"><div class="label">Superadmins</div><div class="value" id="kpiSuper">0</div></article>
        <article class="card kpi"><div class="label">Admins</div><div class="value" id="kpiAdmin">0</div></article>
        <article class="card kpi"><div class="label">Sans téléphone</div><div class="value" id="kpiNoPhone">0</div></article>
      </section>

      <section class="card">
        <div class="filters">
          <input id="searchInput" type="search" placeholder="Rechercher nom/email/téléphone">
          <select id="roleFilter">
            <option value="all">Tous les rôles</option>
            <option value="superadmin">Superadmin</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="table-wrap" id="tableWrap"></div>
      </section>
    </main>
  </div>

  <div class="modal" id="editModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>Éditer le profil admin</strong>
        <button type="button" class="icon-btn" id="closeEditModalBtn"><span class="material-icons">close</span></button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <div class="modal-field">
            <label for="editFullName">Nom complet</label>
            <input id="editFullName" type="text">
          </div>
          <div class="modal-field">
            <label for="editEmail">Email</label>
            <input id="editEmail" type="email">
          </div>
        </div>
        <div class="modal-grid">
          <div class="modal-field">
            <label for="editPhone">Téléphone</label>
            <input id="editPhone" type="tel">
          </div>
          <div class="modal-field">
            <label for="editCompany">Entreprise</label>
            <input id="editCompany" type="text">
          </div>
        </div>
        <div class="modal-field">
          <label for="editRole">Rôle</label>
          <select id="editRole">
            <option value="admin">Admin</option>
            <option value="superadmin">Superadmin</option>
          </select>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn" id="cancelEditBtn">Annuler</button>
        <button type="button" class="btn primary" id="saveEditBtn"><span class="material-icons">save</span>Enregistrer</button>
      </div>
    </div>
  </div>

  <script type="module">
    import AuthService from '../src/auth-service.js';
    import SuperAdminService from '../src/superadmin-service.js';
    import superadminStealth from '../src/superadmin-stealth.js';

    const state = { rows: [], authUsers: [], editingId: null };

    function esc(v){ return String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }
    function dt(v){ if(!v) return '—'; const d=new Date(v); if(Number.isNaN(d.getTime())) return '—'; return d.toLocaleString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
    function setText(id,v){ const el=document.getElementById(id); if(el) el.textContent=String(v); }

    function renderKpis(rows){
      const total = rows.length;
      const superCount = rows.filter(r => String(r.role||'').toLowerCase()==='superadmin').length;
      const adminCount = rows.filter(r => String(r.role||'').toLowerCase()==='admin').length;
      const noPhone = rows.filter(r => !String(r.phone||'').trim()).length;
      setText('kpiTotal', total);
      setText('kpiSuper', superCount);
      setText('kpiAdmin', adminCount);
      setText('kpiNoPhone', noPhone);
    }

    function renderTable(){
      const wrap = document.getElementById('tableWrap');
      const query = String(document.getElementById('searchInput').value || '').trim().toLowerCase();
      const roleFilter = String(document.getElementById('roleFilter').value || 'all').toLowerCase();
      const authById = new Map((state.authUsers || []).map((u) => [String(u.id || ''), u]));

      const rows = (state.rows || []).filter((row) => {
        const role = String(row.role || '').toLowerCase();
        if (roleFilter !== 'all' && role !== roleFilter) return false;
        if (!query) return true;
        const hay = [row.full_name, row.email, row.phone, row.company].join(' ').toLowerCase();
        return hay.includes(query);
      });

      if (!rows.length) {
        wrap.innerHTML = '<div class="empty">Aucun admin trouvé.</div>';
        return;
      }

      wrap.innerHTML = `
        <table>
          <thead><tr><th>Nom</th><th>Email</th><th>Rôle</th><th>Téléphone</th><th>Entreprise</th><th>Dernière connexion</th><th>Création</th><th>Action</th></tr></thead>
          <tbody>
            ${rows.map((row) => {
              const auth = authById.get(String(row.id || '')) || null;
              const role = String(row.role || '').toLowerCase();
              return `
                <tr>
                  <td>${esc(row.full_name || '—')}</td>
                  <td>${esc(row.email || '—')}</td>
                  <td><span class="role ${esc(role)}">${esc(role || 'admin')}</span></td>
                  <td>${esc(row.phone || '—')}</td>
                  <td>${esc(row.company || '—')}</td>
                  <td>${esc(dt(auth?.last_sign_in_at || null))}</td>
                  <td>${esc(dt(row.created_at))}</td>
                  <td><button type="button" class="icon-btn" data-action="edit-admin" data-id="${esc(row.id)}" title="Éditer"><span class="material-icons">edit</span></button></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      wrap.querySelectorAll('button[data-action="edit-admin"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = String(btn.dataset.id || '').trim();
          if (!id) return;
          openEditModal(id);
        });
      });
    }

    function openEditModal(id){
      const row = (state.rows || []).find((r) => String(r.id || '') === String(id || ''));
      if (!row) return;
      state.editingId = row.id;
      document.getElementById('editFullName').value = row.full_name || '';
      document.getElementById('editEmail').value = row.email || '';
      document.getElementById('editPhone').value = row.phone || '';
      document.getElementById('editCompany').value = row.company || '';
      document.getElementById('editRole').value = String(row.role || 'admin').toLowerCase() === 'superadmin' ? 'superadmin' : 'admin';
      const modal = document.getElementById('editModal');
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeEditModal(){
      state.editingId = null;
      const modal = document.getElementById('editModal');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    async function saveEditModal(){
      if (!state.editingId) return;
      const payload = {
        fullName: String(document.getElementById('editFullName').value || '').trim(),
        email: String(document.getElementById('editEmail').value || '').trim(),
        phone: String(document.getElementById('editPhone').value || '').trim(),
        company: String(document.getElementById('editCompany').value || '').trim(),
        role: String(document.getElementById('editRole').value || 'admin').trim().toLowerCase()
      };
      const btn = document.getElementById('saveEditBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class=\"material-icons\">hourglass_top</span>Enregistrement...';
      try {
        await SuperAdminService.updateAdminProfile(state.editingId, payload);
        closeEditModal();
        await loadAll();
      } catch (error) {
        alert(error?.message || 'Mise à jour impossible.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class=\"material-icons\">save</span>Enregistrer';
      }
    }

    function exportCsv(){
      const header = ['id','full_name','email','role','phone','company','created_at'];
      const rows = (state.rows || []).map((r) => [r.id||'',r.full_name||'',r.email||'',r.role||'',r.phone||'',r.company||'',r.created_at||'']);
      const csv = [header, ...rows].map((line) => line.map((v) => {
        const t = String(v ?? '');
        if (!/[",\n]/.test(t)) return t;
        return `"${t.replace(/"/g, '""')}"`;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `superadmin-admin-directory-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function applyDeepLinkEdit(){
      const params = new URLSearchParams(window.location.search || '');
      const editId = String(params.get('edit') || '').trim();
      if (!editId) return;
      const exists = (state.rows || []).some((r) => String(r.id || '') === editId);
      if (!exists) return;
      openEditModal(editId);
    }

    async function loadAll(){
      const [admins, authUsers] = await Promise.all([
        SuperAdminService.getAdmins(),
        SuperAdminService.getAuthenticatedUsers({ limit: 500 }).catch(() => [])
      ]);
      state.rows = Array.isArray(admins) ? admins : [];
      state.authUsers = Array.isArray(authUsers) ? authUsers : [];
      renderKpis(state.rows);
      renderTable();
      setText('lastSync', `Dernière synchronisation: ${dt(new Date())}`);
      applyDeepLinkEdit();
    }

    async function initialize(){
      if (!superadminStealth.ensureStealthOrRedirect({ redirectTo: '/superadmin/login.html' })) return;
      await AuthService.authReady;
      if (!AuthService.isSuperAdmin || !AuthService.isSuperAdmin()) {
        window.location.href = 'login.html';
        return;
      }
      document.body.classList.remove('auth-pending');
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        superadminStealth.clearStealthRecord();
        await AuthService.logout();
      });
      document.getElementById('refreshBtn').addEventListener('click', loadAll);
      document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
      document.getElementById('searchInput').addEventListener('input', renderTable);
      document.getElementById('roleFilter').addEventListener('change', renderTable);
      document.getElementById('closeEditModalBtn').addEventListener('click', closeEditModal);
      document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
      document.getElementById('saveEditBtn').addEventListener('click', saveEditModal);
      document.getElementById('editModal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) closeEditModal();
      });
      await loadAll();
    }

    window.addEventListener('load', initialize);
  </script>
  <script src="/js/refresh-feedback.js" defer></script>
</body>
</html>
